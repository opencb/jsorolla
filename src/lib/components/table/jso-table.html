<dom-module id="jso-table">
    <style>
        :host {
            display: block;
            position: relative;
            font-size: 13px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -ms-user-select: none;
        }

        .scrollfix {
            position: absolute;
            width: 25px;
            height: 100%;
            top: 0;
            right: 0;
            background-color: inherit;
            z-index: 1;
        }

        :host[enable-paging] .scrollfix {
            display: none;
        }

        #wrap {
            height: calc(100% - 30px);
            background-color: #fcfcfc;
        }

        .table-header,
        .table-filter,
        .table-body {
            box-sizing: border-box;
            border-right: 1px solid #dadada;
        }

        .table-header {
            position: relative;
            /*box-sizing: border-box;*/
            background-color: #F1F3F5;
            border-bottom: 1px solid #d3d3d3;
        }

        #headerRow {
            position: relative;
        }

        .table-header-row {
            position: relative;
            box-sizing: border-box;
            font-weight: bold;
            color: #666;
            overflow-y: scroll;
            overflow-x: hidden;
            width: 100%;
            background-color: inherit;
        }

        :host[enable-paging] .table-header-row {
            overflow-y: hidden;
        }

        .table-header-field {
            box-sizing: border-box;
            border-right: 1px solid #d3d3d3;
            /*white-space: nowrap;*/
            /*overflow: hidden;*/
            /*text-overflow: ellipsis;*/
            cursor: pointer;
            position: relative;
        }

        .table-header-field.sort-down > .name:after {
            font-family: 'FontAwesome';
            content: ' \f107';
        }

        .table-header-field.sort-up > .name:after {
            font-family: 'FontAwesome';
            content: ' \f106';
        }

        .table-header-field > .name {
            box-sizing: border-box;
            /*cursor: pointer;*/
            text-align: center;
            padding: 7px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table-header-field > .sub {
            box-sizing: border-box;
            /*cursor: pointer;*/
            text-align: center;
            border-top: 1px solid #d3d3d3;
        }

        div.table-header-field:last-of-type {
            border-right-width: 0;
        }

        .table-filter {
            position: relative;
            /*box-sizing: border-box;*/
            background-color: #F1F3F5;
            border-bottom: 1px solid #d3d3d3;
        }

        #filterRow {
            position: relative;
            height: 26px;
            overflow-y: scroll;
            overflow-x: hidden;
            width: 100%;
            background-color: inherit;
        }

        :host[enable-paging] #filterRow {
            overflow-y: hidden;
        }

        .table-pager {
            font-weight: bold;
            overflow-y: hidden;
            overflow-x: hidden;
        }

        .table-pager > * {
            margin: 0 1px;
        }

        .table-bbar {
            position: relative;
            box-sizing: border-box;
            border-top: 1px solid #d3d3d3;
            background-color: #fafafa;
            color: #666;
            padding: 3px;
        }

        .table-body {
            /*box-sizing: border-box;*/
            overflow-x: auto;
            /*overflow-y: scroll;*/
            height: calc(100% - 31px);
            background-color: #fafafa;
        }

        :host > .table-body {
            overflow-y: scroll;
        }

        :host[enable-paging] > .table-body {
            overflow-y: hidden;
        }

        :host[enable-filter] > .table-body {
            height: calc(100% - 88px);
        }

        .table-row {
            position: relative;
            box-sizing: border-box;
            cursor: default;
            background-color: #fff;
            overflow: hidden;
            border-bottom: 1px solid #ddd;
            height: 30px;
        }

        .table-row.selected {
            background-color: #ccc !important;
        }

        .table-row.selected:hover {
            background-color: #bbb !important;
        }

        div.table-row:last-of-type {
            border-bottom-width: 0;
        }

        .table-row:nth-child(2n) {
            background-color: #fbfbfb;
        }

        .table-row:hover {
            background-color: #eee;
        }

        .table-field {
            position: relative;
            box-sizing: border-box;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-right: 1px solid #d3d3d3;
            float: left;
            height: 100%;
        }

        .table-field > div {
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        div.table-field:last-of-type {
            border-right-width: 0;
        }

        #loading {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            background-color: rgba(125, 125, 125, 0.75);
            z-index: 2;
        }

        #loading-text {
            position: absolute;
            color: white;
            top: 50%;
            left: calc(50% - 62px);
            font-size: 16pt;
            padding: 20px;
            width: 124px;
            /*margin: 0 auto;*/
            /*background-color: rgba(125, 125, 125, 0.5);*/
        }

        .select {
            position: relative;
            display: inline-block;
        }

        .select select {
            box-sizing: content-box;
            width: 100%;
            background: transparent;
            border: 0;
            outline: 0;
            -webkit-appearance: none;
            -moz-appearance: radio-container;
            appearance: none;
        }

        .select select:-moz-focusring {
            color: transparent;
            text-shadow: 0 0 0 #000;
        }

        .select select::-ms-expand {
            display: none;
        }

        .select:after {
            -ms-display: none;
            position: absolute;
            box-sizing: border-box;
            right: 7px;
            top: 0;
            color: inherit;
            font-family: FontAwesome;
            content: '\f107';
            pointer-events: none;
        }

        .select,
        input[type=text] {
            display: block;
            position: relative;
            outline: transparent solid 0px;
            box-sizing: border-box;
            line-height: 21px;
            border: 1px solid #ccc;
            padding: 0px 5px;
            background-color: #fff;
            font-size: inherit;
            font-family: inherit;
            color: inherit;
            height: 23px;
            margin: 1px;
        }

        .table-filter-field:last-child > .select,
        .table-filter-field:last-child > input[type=text] {
            margin-right: 15px;
        }

        :host[enable-paging] .table-filter-field:last-child > .select,
        :host[enable-paging] .table-filter-field:last-child > input[type=text] {
            margin-right: 1px;
        }

        input[type=text] {
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
        }

        input[type=text]:-moz-ui-invalid {
            box-shadow: none;
        }

        input[type=text]:focus {
            border-color: #66afe9;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
        }

        .table-field > .select,
        .table-field > input[type=text] {
            box-sizing: border-box;
            background-color: transparent;
            border-color: transparent;
            height: 100%;
            width: 100%;
            margin: 0;
        }

        .table-field > input[type=text]:hover {
            border-color: #ccc;
        }

        .table-field > input[type=text][readonly]:focus {
            border-color: #ccc;
            box-shadow: inset 0 0 3px 1px rgba(0, 0, 0, .01);
            background-color: #fff;
        }

        .table-field > input[type=text]:focus {
            border-color: #66afe9;
            box-shadow: inset 0 0 3px 1px rgba(102, 175, 233, .5);
            background-color: #fff;
        }

        .table-header-field > .resizer {
            width: 2px;
            height: 100%;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: col-resize;
            display: none;
        }

        .table-header-field:hover > .resizer {
            display: inherit;
            background-color: #E1E3E5;
            border-left: 1px solid #DDD;
        }

        #columnsMenu {
            position: fixed;
            min-width: 200px;
            cursor: pointer;
            transition: opacity 0.1s, visibility 0.1s;
        }

        #columnsMenu {
            max-height: 300px;
            overflow-y: auto;
        }

        div.jso-dropdown ul li:hover,
        ul.jso-context li:hover {
            background-color: var(--default-primary-color);
            color: var(--text-primary-color);
        }

        li.columnControl {
            cursor: pointer;
        }

        li.columnControl:hover,
        li.columnControl:hover {
            background-color: inherit !important;
            color: inherit !important;
        }
    </style>
    <template>
        <div id="loading" hidden$="{{!loading}}">
            <div id="loading-text">
                <i class="fa fa-spinner fa-pulse"></i>
                <span>{{loadingMsg}}</span>
            </div>
        </div>

        <div id="wrap" style="overflow-x: scroll;width:100%;">
            <div id="header" class="table-header" on-contextmenu="handleColumnsMenu">
                <div id="headerRow"></div>
                <div class="scrollfix"></div>
            </div>
            <div id="filter" class="table-filter" hidden$="{{!enableFilter}}">
                <div id="filterRow" hidden$="{{!enableFilter}}"></div>
                <div class="scrollfix"></div>
            </div>
            <div id="list" class="table-body" on-dragover="allowDrop" on-drop="drop"></div>
        </div>


        <div class="horizontal layout center table-bbar">
            <div id="pager" hidden$="{{!enablePaging}}" class="table-pager horizontal layout center flex">
                <div class="jso-btn jso-btn-shdw" on-click="handleFirstClick"><i class="fa fa-angle-double-left"></i></div>
                <div class="jso-btn jso-btn-shdw" on-click="handlePreviousClick"><i class="fa fa-angle-left"></i></div>
                <div class="jso-txt">Page</div>
                <input type="text" class="jso" style="width:80px;" value="{{currentPage::input}}">

                <div class="jso-txt">of</div>
                <div class="jso-txt">{{computePageTotal(pageSize, itemCount)}}</div>

                <div class="jso-btn jso-btn-shdw" on-click="handleNextClick"><i class="fa fa-angle-right"></i></div>
                <div class="jso-btn jso-btn-shdw" on-click="handleLastClick"><i class="fa fa-angle-double-right"></i></div>

                <div class="flex"></div>

                <div class="jso-txt">items</div>
                <div class="jso-txt">{{pageFirstItem}}</div>
                <div class="jso-txt">-</div>
                <div class="jso-txt">{{pageLastItem}}</div>
                <div class="jso-txt">of</div>
                <div class="jso-txt">{{itemCount}}</div>
            </div>


            <div class="horizontal layout">
                <div hidden$="{{enablePaging}}">Total:
                    <span>{{itemCount}}</span>
                </div>
                <div class="jso-btn jso-btn-shdw" on-click="handleColumnsMenuButton">
                    <i class="fa fa-bars"></i>
                </div>
            </div>
        </div>




        <ul id="columnsMenu" class="jso-context" on-mouseleave="handleColumnsMenuLeave" on-wheel="handleMenuScroll">
            <!-- <li>Export</li>
            <li data-divider></li> -->
            <template is="dom-repeat" items="{{columns}}">
                <li class="columnControl">
                    <label class="jso-control">
                        <input type="checkbox" checked$="{{isColumnVisible(item)}}" on-click="handleColumnVisibilityClick">
                        <span>{{item.title}}</span>
                    </label>
                </li>
            </template>
        </ul>

    </template>
</dom-module>
<script>
    Polymer({
        is: 'jso-table',
        properties: {
            columns: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                }
            },
            data: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                }
            },
            viewData: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                }
            },
            request: {
                type: Object,
                observer: 'requestChanged'
            },
            enableRemote: {
                type: Boolean,
                observer: 'enableRemoteChanged',
                value: false
            },
            enablePaging: {
                type: Boolean,
                observer: 'enablePagingChanged',
                value: false
            },
            enableResize: {
                type: Boolean,
                value: false
            },
            pageSize: {
                type: Number,
                observer: 'pageSizeChanged',
                value: 10
            },
            currentPage: {
                type: Number,
                observer: 'currentPageChanged',
                value: 1
            },
            pageFirstItem: {
                type: Number,
                computed: 'computePageFirstItem(currentPage, pageSize, itemCount)',
                value: 0
            },
            pageLastItem: {
                type: Number,
                computed: 'computePageLastItem(currentPage, pageSize, itemCount)',
                value: 0
            },
            selected: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                }
            },
            enableSelect: {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },
            disableTooltip: {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },
            lastSelectedRow: {
                type: Object,
                value: null
            },
            enableFilter: {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },
            filters: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            itemCount: {
                type: Number,
                value: 0
            },
            pageCount: {
                type: Number,
                value: 0
            },
            loading: {
                type: Boolean,
                value: false,
                observer: 'handleLoading'
            },
            loadingMsg: {
                type: String,
                value: 'Loading'
            },
            draggable: {
                type: Boolean,
                reflectToAttribute: true,
                value: false,
            },
            enableEdit: {
                type: Boolean,
                reflectToAttribute: true,
                value: false,
            }
        },
        observers: [
            "dataChanged(data.splices)",
            "selectedChanged(selected.splices)",
            "viewDataChanged(viewData.splices)",
            'columnsChanged(columns.splices)',
        ],
        listeners: {
            'wheel': 'handleScroll',
            'mouseleave': 'handleColumnsMenuLeave',
        },
        isColumnVisible: function(v) {
            return v.visible !== false;
        },
        handleColumnVisibilityClick: function(e) {
            var columnIndex = this.columns.indexOf(e.model.item);
            this.set('columns.' + columnIndex + '.visible', e.currentTarget.checked);
            this.columnsChanged();
        },
        /* LISTENERS */
        handleScroll: function(e) {
            e.preventDefault();
            if (e.deltaY > 0) {
                this.handleNextClick();
            }
            if (e.deltaY < 0) {
                this.handlePreviousClick();
            }
        },
        handleColumnsMenu: function(e) {
            e.preventDefault();
            e.stopPropagation();

            this.$.columnsMenu.style.opacity = "1";
            this.$.columnsMenu.style.visibility = "visible";
            this.$.columnsMenu.style.top = (e.clientY + 10) + "px";
            this.$.columnsMenu.style.left = (e.clientX) + "px";
        },
        handleColumnsMenuButton: function(e) {
            e.preventDefault();
            e.stopPropagation();

            this.$.columnsMenu.style.opacity = "1";
            this.$.columnsMenu.style.visibility = "visible";
            var bcrColumnsMenu = this.$.columnsMenu.getBoundingClientRect();
            var bcrCurrent = e.currentTarget.getBoundingClientRect();
            this.$.columnsMenu.style.top = (bcrCurrent.top - bcrColumnsMenu.height) + "px";
            this.$.columnsMenu.style.left = (bcrCurrent.left - bcrColumnsMenu.width + bcrCurrent.width) + "px";
        },
        handleColumnsMenuLeave: function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.$.columnsMenu.style.opacity = "";
            this.$.columnsMenu.style.visibility = "";
        },
        handleMenuScroll: function(e) {
            e.stopPropagation();
        },

        selectedChanged: function(changeRecord) {
            this._updateSelected();
            this.fire('selected', this.selected);
        },
        _updateSelected: function() {
            var els = Polymer.dom(this.$.list).querySelectorAll('.table-row');
            for (var i = 0; i < els.length; i++) {
                var el = els[i];
                var index = this.selected.indexOf(el._rowData);
                if (index >= 0) {
                    el.classList.add("selected");
                } else {
                    el.classList.remove("selected");
                }
            }
        },
        /* OBSERVERS */
        dataChanged: function(neo, old) {
            for (var i = 0; i < this.data.length; i++) {
                var row = this.data[i];
                delete row._filtered;
            }
            this.refreshPagination();
        },
        refreshPagination: function() {
            this.currentPage = 1;
            var count = 0;
            if (this.data) {
                this.data.forEach(function(row) {
                    if (row._filtered || row._filtered == null) {
                        count++;
                    }
                });
            }
            this.itemCount = count;
            this.pageCount = Math.ceil(count / this.pageSize);
            this.filterPage();
        },
        filterPage: function() {
            var filteredRows = this.enableFilter ? this.data.filter(function(r) {
                if (r._filtered == undefined) {
                    return true;
                }
                return r._filtered;
            }) : this.data;
            if (this.enablePaging) {
                var from = (this.currentPage - 1) * this.pageSize;
                var to = from + this.pageSize;
                if (this.request) {
                    this.checkRemote();
                } else {
                    this.set('viewData', filteredRows.slice(from, to));
                    this._updateSelected();
                }
            } else {
                var viewData = [];
                for (var i = 0; filteredRows && i < filteredRows.length; i++) {
                    var row = filteredRows[i];
                    viewData.push(row);
                }
                this.set('viewData', viewData);
            }
        },
        viewDataChanged: function(neo, old) {
            while (this.$.list.firstChild) {
                this.$.list.removeChild(this.$.list.firstChild);
            }
            for (var i = 0; this.viewData && i < this.viewData.length; i++) {
                var rowData = this.viewData[i];
                this._createRow(rowData);
            }
        },
        // pagination
        handleFirstClick: function() {
            this.currentPage = 1;
        },
        handlePreviousClick: function() {
            if (this.currentPage > 1) {
                this.currentPage--;
            }
        },
        handleNextClick: function() {
            // console.log(this.currentPage);
            // console.log(this.pageCount);
            if (this.currentPage < this.pageCount) {
                this.currentPage++;
            }
        },
        handleLastClick: function() {
            this.currentPage = this.pageCount;
        },
        currentPageChanged: function(neo, old) {
            this.currentPage = this.currentPage ? parseInt(this.currentPage) : 0;
            this.currentPage = this.currentPage < 1 ? 1 : this.currentPage;
            this.currentPage = this.pageCount > 0 && this.currentPage > this.pageCount ? this.pageCount : this.currentPage;
            this.filterPage();
        },
        pageSizeChanged: function() {
            this.pagesize = parseInt(this.pagesize);
            this.refreshPagination();
        },
        computePageFirstItem: function(currentPage, pageSize, itemCount) {
            return ((currentPage - 1) * pageSize) + 1;
        },
        computePageLastItem: function(currentPage, pageSize, itemCount) {
            var end = currentPage * pageSize;
            if (itemCount < end) {
                return itemCount;
            }
            return end;
        },
        computePageTotal: function(pageSize, itemCount) {
            return Math.ceil(itemCount / pageSize);
        },
        enablePagingChanged: function(neo, old) {
            this.refreshPagination();
        },
        enableRemoteChanged: function(neo, old) {
            if (this.request) {
                this.checkRemote();
            }
        },
        requestChanged: function(neo, old) {
            if (this.currentPage != 1) {
                this.currentPage = 1;
            } else if (this.request) {
                this.checkRemote();
            }
        },
        columnsChanged: function(neo, old) {
            this.updateColumns();
            this.viewDataChanged();
        },
        clear: function() {
            this.data = [];
            this.viewData = [];
            this.currentPage = 1;
            this.columns = [];
            //            this.totalItems = 0;
        },
        refresh: function() {
            this.dataChanged();
        },
        checkRemote: function() {
            var me = this;
            if (this.enableRemote) {
                this._callRemote(function(resp) {
                    me.itemCount = me.request.parseTotal(resp);
                    me.pageCount = Math.ceil(me.itemCount / me.pageSize);
                    me.viewData = me.request.parse(resp);
                });
            } else {
                //                ...
            }
        },
        _callRemote: function(callback) {
            var method = 'GET';
            if (typeof this.request.method !== 'undefined' && this.request.method != null) {
                method = this.request.method;
            }
            var request = new XMLHttpRequest();
            request.onload = function() {
                var contentType = this.getResponseHeader('Content-Type');
                var resp;
                if (contentType === 'application/json') {
                    resp = JSON.parse(this.response, this);
                } else {
                    resp = this.response;
                }
                callback(resp)
            };
            request.onerror = function() {
                //                args.request.error(this);
            };
            var url = Utils.addQueryParamtersToUrl({
                skip: ((this.currentPage - 1) * this.pageSize),
                limit: this.pageSize
            }, this.request.url);
            request.open(method, url, true);
            request.send();
            console.log(url)
        },
        updateColumns: function() {
            var els = this.$.headerRow.querySelectorAll('.table-header-row');
            for (var i = 0; i < els.length; i++) {
                this.$.headerRow.removeChild(els[i]);
            }

            els = this.$.filterRow.children;
            for (var i = 0; i < els.length; i++) {
                this.$.filterRow.removeChild(els[i]);
            }

            var totalColWidth = 0;
            for (var i = 0; i < this.columns.length; i++) {
                var x = [];
                var column = this.columns[i];
                // set default width
                if (isNaN(column.width)) {
                    column.width = 100;
                }
                this._processColumn(column, x);
                column.plainColumns = x;
                if (column.visible !== false) {
                    totalColWidth += column.width;
                }

            }
            this._createHeaderRow();
            this._createFilterRow();


            this.$.header.style.width = totalColWidth + 'px';
            this.$.filter.style.width = totalColWidth + 'px';
            this.$.list.style.width = totalColWidth + 'px';

            if (totalColWidth === 0) {
                this.$.list.setAttribute('hidden', '');
            } else {
                this.$.list.removeAttribute('hidden');
            }

        },
        _createFilterRow: function() {
            var el = document.createElement('div');
            el.classList.add('horizontal', 'layout', 'style-scope', 'jso-table');
            for (var i = 0; i < this.columns.length; i++) {
                var column = this.columns[i];
                if (column.visible !== false) {
                    this._createFilterField(el, column);
                }
            }
            this.$.filterRow.appendChild(el);
        },
        _createFilterField: function(rowEl, column, rowData) {
            var me = this;
            var el = document.createElement('div');
            el.classList.add('table-filter-field', 'horizontal', 'layout', 'style-scope', 'jso-table');
            if (isNaN(column.width)) {
                el.classList.add('flex');
            } else {
                el.style.width = column.width + "px";
                el.style.minWidth = column.width + "px";
            }
            if (column.plainColumns.length > 0) {
                // TODO aaleman: nested columns
                //                for (var i = 0; i < column.plainColumns.length; i++) {
                //
                //                    var cEl = document.createElement('div');
                //                    var c = column.plainColumns[i];
                //                    cEl.style.width = c.width + "px";
                //                    var defValue = c.defaultValue != null ? c.defaultValue : '';
                //                    var value = null;
                //                    if (c.formula) {
                //                        value = c.formula(rowData);
                //                    } else {
                //                        value = this._deepValue(rowData, c.ak);
                //                    }
                //                    cEl.innerHTML = value != null ? value : defValue;
                //                    el.appendChild(cEl);
                //                }
            } else {
                if (!column.type) {
                    column.type = 'text';
                }
                switch (column.type) {
                    case 'text':
                        var input = document.createElement("input");
                        input.setAttribute("type", "text");
                        input.setAttribute("placeholder", "filter by " + column.title);
                        input.classList.add('style-scope', 'jso-table');
                        if (isNaN(column.width)) {
                            input.classList.add('flex');
                        } else {
                            input.style.width = column.width + "px";
                        }
                        input._col = column.name;
                        input.addEventListener('input', function(e) {
                            var query = this.value;
                            var filter = {}
                            if (input._col in me.filters) {
                                filter = me.filters[input._col];
                            }
                            if (query != "") {
                                filter.type = 'text';
                                filter.colName = input._col;
                                filter.query = query;
                                filter.func = null;
                                me.filters[input._col] = filter;
                            } else {
                                delete me.filters[input._col];
                            }
                            me._applyFilters();
                        });
                        el.appendChild(input);
                        break;
                    case 'select':
                        var selwrap = document.createElement("div");
                        selwrap.classList.add('style-scope', 'jso-table', 'select');
                        if (isNaN(column.width)) {
                            selwrap.classList.add('flex');
                        } else {
                            selwrap.style.width = column.width + "px";
                        }
                        var input = document.createElement("select");
                        input.classList.add('style-scope', 'jso-table');
                        selwrap.appendChild(input);

                        input._col = column.name;
                        var option = document.createElement("option");
                        var optVal = "";
                        option.value = optVal;
                        option.text = optVal;
                        input.appendChild(option);
                        for (var i = 0; i < column.options.length; i++) {
                            option = document.createElement("option");
                            optVal = column.options[i];
                            option.value = optVal;
                            option.text = optVal;
                            input.appendChild(option);
                        }
                        input.addEventListener('click', function(e) {
                            var query = this.value;
                            var filter = {}
                            if (input._col in me.filters) {
                                filter = me.filters[input._col];
                            }
                            if (query != "") {
                                filter.type = 'select';
                                filter.colName = input._col;
                                filter.query = query;
                                filter.func = null;
                                me.filters[input._col] = filter;
                            } else {
                                delete me.filters[input._col];
                            }
                            me._applyFilters();
                        });
                        el.appendChild(selwrap);
                        break;
                    default:
                        var input = document.createElement("div");
                        el.appendChild(input);
                        break;
                }
            }
            rowEl.appendChild(el);
        },
        _applyFilters: function() {
            for (var i = 0; i < this.data.length; i++) {
                var row = this.data[i];
                var filtered = true;
                for (var key in this.filters) {
                    var filter = this.filters[key];
                    var match = false;
                    switch (filter.type) {
                        case 'text':
                            var value = row[filter.colName].toLowerCase();
                            match = (value.indexOf(filter.query.toLowerCase()) >= 0);
                            break;
                        case 'select':
                            var value = row[filter.colName].toLowerCase();
                            match = (value === filter.query.toLowerCase());
                            break;
                    }
                    filtered &= match;
                }
                row._filtered = filtered;
            }
            this.refreshPagination();
        },
        _processColumn: function(column, x) {
            if (column.columns && column.columns.length > 0) {
                for (var i = 0; i < column.columns.length; i++) {
                    var col = column.columns[i];
                    col._parentColumn = column;

                    if (column.ak) {
                        col.ak = column.ak + "." + col.name
                    } else {
                        col.ak = column.name + "." + col.name
                    }
                    if (col.columns == null) {
                        x.push(col);
                    }
                    this._processColumn(col, x);
                }
            }
        },
        _createHeaderRow: function() {
            var el = document.createElement('div');
            el.classList.add('table-header-row', 'horizontal', 'layout', 'style-scope', 'jso-table');
            for (var i = 0; i < this.columns.length; i++) {
                var column = this.columns[i];
                if (column.visible !== false) {
                    this._createHeaderField(el, column);
                }
            }
            this.$.headerRow.appendChild(el);
        },
        _setResizable: function(elem) {
            var me = this;

            var columnName = ".column-" + elem._column.name;

            var resizer = document.createElement('div');
            resizer.classList.add("resizer", 'style-scope', 'jso-table');
            elem.appendChild(resizer);

            var startX, startWidth;

            function initDrag(e) {
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(elem).width, 10);
                document.documentElement.addEventListener('mousemove', doDrag, false);
                document.documentElement.addEventListener('mouseup', stopDrag, false);
            }

            function doDrag(e) {
                elem.style.width = (startWidth + e.clientX - startX) + 'px';
                elem.style.minWidth = (startWidth + e.clientX - startX) + 'px';
            }

            function stopDrag(e) {


                document.documentElement.removeEventListener('mousemove', doDrag, false);
                document.documentElement.removeEventListener('mouseup', stopDrag, false);

                var dif = e.clientX - startX;

                elem.style.width = (startWidth + dif) + 'px';
                elem._column.width = (startWidth + dif);

                var parentColumn = elem._column._parentColumn;
                while (parentColumn != null) {
                    parentColumn.width += dif;
                    parentColumn = parentColumn._parentColumn;
                }


                function resizeChildren(columns, d) {

                    if (Array.isArray(columns)) {

                        for (var i = 0; i < columns.length; i++) {
                            var col = columns[i];

                            col.width += (d / columns.length);
                            resizeChildren(col.columns, d / columns.length);
                        }
                    }
                }

                resizeChildren(elem._column.columns, dif);


                me.updateColumns();
                me.viewDataChanged();
            }

            resizer.addEventListener('mousedown', initDrag, false);
        },

        _createHeaderField: function(rowEl, column) {
            var me = this;
            var el = document.createElement('div');
            el.classList.add('table-header-field', 'vertical', 'layout', 'center-justified', 'style-scope', 'jso-table', ('column-' + column.name.replace(/\s/g, '_')));
            if (isNaN(column.width)) {
                el.classList.add('flex');
            } else {
                el.style.width = column.width + "px";
                el.style.minWidth = column.width + "px";
            }
            el._column = column;
            var nameEl = document.createElement('div');
            nameEl.classList.add('name', 'style-scope', 'jso-table');
            nameEl.innerHTML = column.title;
            el.appendChild(nameEl);

            if (this.enableResize) {
                this._setResizable(el);
            }

            if (column.columns && column.columns.length > 0) {
                var subColumnsEl = document.createElement('div');
                subColumnsEl.classList.add('sub', 'horizontal', 'layout', 'style-scope', 'jso-table');
                for (var i = 0; i < column.columns.length; i++) {
                    var subColumn = column.columns[i];
                    this._createHeaderField(subColumnsEl, subColumn);
                }
                el.appendChild(subColumnsEl);
            } else {
                el.addEventListener('click', this.handleHeaderFieldClick.bind(this));
            }
            rowEl.appendChild(el);
        },
        handleHeaderFieldClick: function(e) {
            var me = this;
            var column = e.currentTarget._column;
            var sortedData = this.data.slice(0);
            var els = this.querySelectorAll('.table-header-field');
            var isSortDown = e.currentTarget.classList.contains("sort-down");
            for (var i = 0; i < els.length; i++) {
                var el = els[i];
                el.classList.remove('sort-down');
                el.classList.remove('sort-up');
            }
            if (isSortDown) {
                sortedData.sort(function(a, b) {
                    return me._columnSort(column, b, a);
                });
                e.currentTarget.classList.add('sort-up');
            } else {
                sortedData.sort(function(a, b) {
                    return me._columnSort(column, a, b);
                });
                e.currentTarget.classList.add('sort-down');
            }
            this.data = sortedData;
        },
        _columnSort: function(column, a, b) {
            //checking formula or TODO save calculated value in the item;
            var aVal, bVal;
            if (column.formula != null) {
                aVal = column.formula(a);
                bVal = column.formula(b);
            } else {
                aVal = a[column.name];
                bVal = b[column.name];
            }
            if (!isNaN(bVal) && !isNaN(aVal)) {
                return aVal - bVal;
            } else {
                return (aVal > bVal) - (aVal < bVal);
            }
        },
        _getPos: function(row) {
            for (var i = 0; i < this.viewData.length; i++) {
                var elem = this.viewData[i];
                if (elem === row) {
                    return i;
                }
            }
            return -1;
        },
        _createRow: function(rowData) {
            var me = this;
            var el = document.createElement('div');
            el.classList.add('table-row', 'horizontal', 'layout', 'style-scope', 'jso-table');
            el._rowData = rowData;
            var id = "idRow_" + this._getPos(rowData);
            el.setAttribute("id", id);
            if (this.draggable) {
                el.setAttribute("draggable", "true");
                el.addEventListener('dragstart', this.drag);
            }
            el.addEventListener('click', function(e) {
                me.fire('rowclick', {
                    row: rowData
                });
                var currentTarget = e.currentTarget;
                console.log("Position: " + me._getPos(currentTarget._rowData));
                if (me.enableSelect) {
                    if (e.ctrlKey) {
                        me._toggleSelected(currentTarget, rowData);
                    }
                    if (e.button === 0) {
                        if (!e.ctrlKey && !e.shiftKey) {
                            me._clearSelection();
                            me._toggleSelected(currentTarget, rowData);
                        }
                        if (e.shiftKey) {
                            var first = me._getPos(me.lastSelectedRow._rowData);
                            var last = me._getPos(currentTarget._rowData);
                            if (last < first) {
                                var tmp = last;
                                last = first;
                                first = tmp;
                            }
                            me._selectRowsBetweenIndexes(first, last);
                        }
                    }
                }
            });
            for (var i = 0; i < this.columns.length; i++) {
                var column = this.columns[i];
                if (column.visible !== false) {
                    this._createField(el, column, rowData);
                }
            }
            this.$.list.appendChild(el);
        },
        _toggleSelected: function(domElem, rowData) {
            if (domElem.classList.contains("selected")) {
                var index = this.selected.indexOf(rowData);
                if (index >= 0) {
                    this.splice('selected', index, 1);
                    domElem.classList.remove("selected");
                }
            } else {
                if (this.selected.indexOf(rowData) < 0) {
                    this.push('selected', rowData);
                    domElem.classList.add("selected");
                }
            }
            this.lastSelectedRow = domElem;
        },
        _selectRowsBetweenIndexes: function(first, last) {
            var rows = this.$.list.getElementsByClassName("table-row");
            for (var i = 0; i < rows.length; i++) {
                var obj = rows[i];
                var pos = this._getPos(obj._rowData);
                var index = this.selected.indexOf(obj._rowData);
                if (pos >= first && pos <= last) {
                    obj.classList.add("selected");
                    if (index < 0) {
                        this.push('selected', obj._rowData);
                    }
                } else {
                    if (index >= 0) {
                        this.splice('selected', index, 1);
                    }
                }
            }
        },
        _clearSelection: function() {
            var rows = this.$.list.getElementsByClassName("table-row");
            for (var i = 0; i < rows.length; i++) {
                var obj = rows[i];
                obj.classList.remove("selected");
            }
            this.splice('selected', 0, this.selected.length);
        },
        _createField: function(rowEl, column, rowData) {
            var me = this;
            var el = document.createElement('div');
            el.classList.add('table-field', 'horizontal', 'layout', 'center', 'style-scope', 'jso-table');
            if (isNaN(column.width)) {
                el.classList.add('flex');
            } else {
                el.style.width = column.width + "px";
                el.style.minWidth = column.width + "px";
            }
            if (column.type === "action") {
                var remove = document.createElement("i");
                remove.classList.add("fa", "fa-remove");
                remove.addEventListener('click', function(e) {
                    me.fire('removerow', {
                        row: rowData
                    });
                    var pos = me._getPos(rowData);
                    if (pos >= 0) {
                        me.splice('data', pos, 1);
                    }
                });
                el.appendChild(remove);
            } else if (column.plainColumns.length > 0) {
                for (var i = 0; i < column.plainColumns.length; i++) {
                    var c = column.plainColumns[i];
                    this._createTypeField(el, c, rowData, true);
                }
            } else {
                this._createTypeField(el, column, rowData);
            }
            rowEl.appendChild(el);
        },
        _createTypeField: function(el, column, rowData, isSubCol) {
            var me = this;
            var value;
            var defValue = column.defaultValue;

            if (column.formula) {
                value = column.formula(rowData);
            } else {
                if (isSubCol == true) {
                    value = this._deepValue(rowData, column.ak);
                } else {
                    value = rowData[column.name];
                }
            }

            // set empty string if no value found.
            value = (value == null) ? defValue : value;
            value = (value == null) ? '' : value;

            if (this.enableEdit && column.editable != false) {
                if (!column.type) {
                    column.type = 'text';
                }
                switch (column.type) {
                    case 'text':
                        var input = document.createElement("input");
                        input.setAttribute("type", "text");
                        input.setAttribute("placeholder", "");
                        input.setAttribute("readonly", "");
                        input.classList.add('style-scope', 'jso-table');
                        input._col = column.name;
                        input.addEventListener('dblclick', function(e) {
                            this.removeAttribute('readonly');
                        });
                        input.addEventListener('blur', function(e) {
                            if (!this.hasAttribute('readonly')) {
                                this.setAttribute('readonly', '');
                                var val = this.value;
                                rowData.attributes[column.name] = val;
                                me.fire('update-row', rowData);
                            }
                        });
                        input.value = value;
                        el.appendChild(input);
                        break;
                    case 'select':
                        //TODO check styles
                        el.classList.add('table-field-nopadding');
                        var selwrap = document.createElement("div");
                        selwrap.classList.add('style-scope', 'jso-table', 'select');
                        if (isNaN(column.width)) {
                            selwrap.classList.add('flex');
                        } else {
                            selwrap.style.width = column.width + "px";
                        }
                        var input = document.createElement("select");
                        input.classList.add('style-scope', 'jso-table');
                        selwrap.appendChild(input);
                        input._col = column.name;
                        var option = document.createElement("option");
                        var optVal = "";
                        option.value = optVal;
                        option.text = optVal;
                        input.appendChild(option);
                        for (var i = 0; i < column.options.length; i++) {
                            option = document.createElement("option");
                            optVal = column.options[i];
                            option.value = optVal;
                            option.text = optVal;
                            input.appendChild(option);
                        }
                        //TODO check
                        input.addEventListener('click', function(e) {
                            var val = this.value;
                            rowData.attributes[column.name] = val;
                        });
                        input.value = value;
                        el.appendChild(selwrap);
                        break;
                }
            } else {
                var cEl = document.createElement('div');
                cEl.classList.add('style-scope', 'jso-table');
                if (isNaN(column.width)) {
                    cEl.classList.add('flex');
                } else {
                    cEl.style.width = column.width + "px";
                }
                cEl.innerHTML = value;
                if (!this.disableTooltip) {
                    var tooltipValue = value;
                    cEl.setAttribute("title", tooltipValue);
                }

                cEl.classList.add('column-' + column.name.replace(/\s/g, '_'));
                el.appendChild(cEl);
            }
        },
        _deepValue: function(obj, path) {
            for (var i = 0, path = path.split('.'), len = path.length; i < len; i++) {
                var auxPath = path[i];
                if (auxPath === "undefined") {
                    continue;
                }
                obj = auxPath;
            }
            return obj;
        },
        contains: function(searchElem, compareFunction) {
            var cmp = function(a, b) {
                return a === b;
            }
            if (compareFunction && typeof(compareFunction) === "function") {
                cmp = compareFunction;
            }
            for (var i = 0; i < this.data.length; i++) {
                var elem = this.data[i];
                if (cmp(searchElem, elem)) {
                    return true;
                }
            }
            return false;
        },
        setLoading: function(loading) {
            this.loading = loading;
        },
        allowDrop: function(e) {
            console.log("drag!!!")
            e.preventDefault();
        },
        drop: function(e) {
            e.preventDefault();
            var data = JSON.parse(e.dataTransfer.getData("rowData"));
            this.push('data', data);
        },
        drag: function(e) {
            e.dataTransfer.setData("rowData", JSON.stringify(e.currentTarget._rowData));
        },
        handleLoading: function(neo, old) {},


        selectElem: function(elem, compareFunction) {


            var selected = null;

            for (var i = 0; i < this.viewData.length && selected == null; i++) {
                var obj = this.viewData[i];
                if (compareFunction(elem, obj)) {
                    selected = obj;
                }
            }

            if (selected != null) {
                this.selected = [selected];
            } else {
                this._clearSelection();
            }


        }
    })
</script>
