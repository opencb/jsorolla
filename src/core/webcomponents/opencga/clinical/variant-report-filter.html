<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="variant-clinical-selector.html">
<link rel="import" href="../opencga-message-dialog.html">

<dom-module id="variant-report-filter">
    <template>
        <style include="jso-styles">
            label {
                padding-top: 10px;
            }
            .labelReportFilter {
                display: block;
            }
        </style>

        <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">
            <!-- Analysis Information -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}GeneralHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}FillInputsGeneral"
                           aria-expanded="true" aria-controls="{{prefix}}General">
                            Personal Information
                        </a>
                    </h4>
                </div>

                <div id="{{prefix}}FillInputsGeneral" class="panel-collapse collapse in" role="tabpanel"
                     aria-labelledby="{{prefix}}GeneralHeading">
                    <div class="panel-body">
                        <div id="{{prefix}}FillInputsGeneralDiv" style="">
                            <label class="labelReportFilter">Service petitioner:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}ApplicantInput" id="{{prefix}}ApplicantInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.applicant::input}}">
                            <label class="labelReportFilter">Departament:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}DepartmentInput" id="{{prefix}}DepartmentInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.department::input}}">
                            <label class="labelReportFilter">City:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}CityInput" id="{{prefix}}CityInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.city::input}}">
                            <label class="labelReportFilter">Patient:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}PatientInput" id="{{prefix}}PatientInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.patient::input}}">
                            <label class="labelReportFilter">NUHSA:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}nuhsaInput" id="{{prefix}}nuhsaInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.nuhsa::input}}">
                            <label class="labelReportFilter">Family Number:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}FamilyNumberInput" id="{{prefix}}FamilyNumberInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.familyNumber::input}}">
                            <label class="labelReportFilter">Analysis type:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}AnalysisTypeInput" id="{{prefix}}AnalysisTypeInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.analysisType::input}}">
                            <label class="labelReportFilter">Entry date:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}EntryDateInput" id="{{prefix}}EntryDateInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.entryDate::input}}">
                            <label class="labelReportFilter">Birth Year:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}nuhsaInput" id="{{prefix}}birthYear" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.birthYear::input}}">
                            <label class="labelReportFilter">Relationship:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}RelationshipInput" id="{{prefix}}RelationshipInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.relationship::input}}">
                            <label class="labelReportFilter">Physician one:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}SignLeft" id="{{prefix}}SignLeftInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.signLeft::input}}">
                            <label class="labelReportFilter">Physician two:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}SignRightInput" id="{{prefix}}SignRightInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.signRight::input}}">
                        </div>

                    </div>
                </div>

            </div>
            <!-- Analysis Information -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleAnalysisHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}AnalysisSelector"
                           aria-controls="{{prefix}}AnalysisSelector">
                            Analysis
                        </a>
                    </h4>
                </div>

                <div id="{{prefix}}AnalysisSelector" class="panel-collapse collapse" role="tabpanel"
                     aria-labelledby="{{prefix}}SampleFilterHeading">
                    <div class="panel-body">
                        <div id="{{prefix}}analysisSelectedDiv" style="">
                            <label class="labelReportFilter">Analysis selected:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}FilterTextInput"
                                   placeholder="{{currentAnalysisID}}" aria-describedby="basic-addon1" disabled>
                        </div>
                        <div id="{{prefix}}reasonConsultationHeaderDiv" style="">
                            <label class="labelReportFilter">Presenting complaint:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}ReasonConsultationTextInput" id="{{prefix}}ReasonConsultationTextInput" placeholder="___"
                                   placeholder="{{currentAnalysisID}}" aria-describedby="basic-addon1" value="{{dataFieldsPrivate.reasonConsultation::input}}">
                        </div>
                        <div id="{{prefix}}analysisResumeDiv" hidden>
                            <input type="checkbox" name="analysisButtons" id="{{prefix}}AnalysisResume"
                                   value="analysisResume" class$="{{prefix}}FilterRadio" on-change="showAnalysisResume"
                                   style="padding-left: 20px"> Analysis Summary<br>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Interpretation -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}InterpretationHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}InterpretationContent"
                           aria-expanded="true" aria-controls="{{prefix}}Interpretation">
                            Interpretation
                        </a>
                    </h4>
                </div>

                <div id="{{prefix}}InterpretationContent" class="panel-collapse collapse" role="tabpanel"
                     aria-labelledby="{{prefix}}InterpretationHeading">
                    <div class="panel-body">
                        <div id="{{prefix}}FillInputsInterpretationDiv" style="">
                            <label class="labelReportFilter">Depth:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}DepthInput" id="{{prefix}}DepthInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.depth::input}}">
                            <label class="labelReportFilter">Coverage:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}CoverageInput" id="{{prefix}}CoverageInput" placeholder="___"
                                   aria-describedby="basic-addon1" value="{{dataFieldsPrivate.coverage::input}}">
                            <label class="labelReportFilter">Interpretation Comments(Only for positive diagnosis):</label>
                            <textarea type="text" class$="{{prefix}}extraInfoInput" id="{{prefix}}extraInfoInput" placeholder="___"
                                       rows="5" value="{{dataFieldsPrivate.extraInterpretation::input}}"></textarea>
                        </div>

                    </div>
                </div>

            </div>

            <!-- Other information -->
            <div class="panel panel-default" id="{{prefix}}OtherInformationDiv" style="">
                <div class="panel-heading" role="tab" id="{{prefix}}OtherInformationHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}OtherInformationContent" aria-expanded="true"
                           aria-controls="{{prefix}}OtherInformationContent">
                            Other Information
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Other information">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}OtherInformationContent" class="panel-collapse collapse" role="tabpanel"
                     aria-labelledby="{{prefix}}OtherInformationHeading">
                    <div class="panel-body">
                        <div class="form-group">
                            <div id="{{prefix}}editableConclusion" style="">

                                <label class="labelReportFilter">Select</label>
                                <br>
                                <input type="checkbox" name="otherButtons" id="{{prefix}}Conclusions" value="conclusions"
                                       class$="{{prefix}}FilterRadio" on-change="showConclusions"
                                       style="padding-left: 20px"> Editable conclusions<br>
                            </div>
                            <div id="{{prefix}}attached1Div" style="">
                                <input type="checkbox" name="prioritizationButtons" checked id="{{prefix}}attached1"
                                       value="attached1" class$="{{prefix}}FilterRadio" on-change="showAttached1"
                                       style="padding-left: 20px"> Gene panel<br>
                            </div>
                            <div id="{{prefix}}filterSummaryHeaderDiv" style="">
                                <input type="checkbox" name="prioritizationButtons" id="{{prefix}}FilterResume"
                                       value="filterResume" class$="{{prefix}}FilterRadio" on-change="showAttached2"
                                       style="padding-left: 20px"> Prioritization filter<br>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!--&lt;!&ndash; Modal dialog for Analysis Browser&ndash;&gt;-->
        <!--<div class="modal fade" id="{{prefix}}AnalysisBrowser" tabindex="-1" role="dialog"-->
        <!--aria-labelledby="sampleBrowserLabel">-->
        <!--<div class="modal-dialog modal-lg" role="document" style="width: 1024px;">-->
        <!--<div class="modal-content">-->
        <!--<div class="modal-header">-->
        <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span-->
        <!--aria-hidden="true">&times;</span></button>-->
        <!--<h4 class="modal-title" id="{{prefix}}AnalysisBrowserLabel">Analysis Selector</h4>-->
        <!--</div>-->
        <!--<div class="modal-body" style="height: 650px">-->
        <!--&lt;!&ndash;<variant-clinical-selector opencga-client="{{opencgaClient}}" analysis="{{analysis}}" analysis-selected="{{analysisSelected}}"></variant-clinical-selector>&ndash;&gt;-->
        <!--<variant-clinical-selector opencga-client="{{opencgaClient}}"-->
        <!--analysis-selected="{{analysisSelected}}" study="{{study}}"-->
        <!--analysis-modal="{{analysisModal}}"-->
        <!--show-pedigree="{{showPedigree}}"></variant-clinical-selector>-->
        <!--</div>-->
        <!--<div class="modal-footer">-->
        <!--<button type="button" class="btn btn-primary" data-dismiss="modal" on-click="showReportOptions">-->
        <!--OK-->
        <!--</button>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <div style="width: 60%;margin: 0 auto">
            <button type="button" class="btn btn-primary btn-md" style="width: 100%" on-click="onSave">
                <i class="fa fa-floppy-o" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                Save report
            </button>
        </div>
        <br>
        <div style="width: 60%;margin: 0 auto">
            <button type="button" class="btn btn-primary btn-md" style="width: 100%" on-click="onExport">
                <i class="fa fa-file-pdf-o" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                Export report
            </button>

        </div>
        <opencga-message-dialog opencga-client="{{opencgaClient}}" show-message-modal="{{showMessageModal}}"
                                settings-message-modal="{{settingsMessageModal}}"></opencga-message-dialog>
    </template>

    <script>
        class VariantReportFilter extends Polymer.Element {
            static get is() {
                return 'variant-report-filter'
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object
                    },
                    study: {
                        type: Object,
                        observer: 'updateVariableSets'
                    },
                    prefix: {
                        type: String
                    },
                    config: {
                        type: Object
                    },
                    selection: {
                        type: Object,
                        notify: true
                    },
                    variables: {
                        type: Array,
                        notify: true
                    },
                    expReport: {
                        type: Boolean,
                        notify: true
                    },
                    analysisSelected: {
                        type: Object
                    },
                    dataFields: {
                        type:Object,
                        notify: true
                    },
                    interpretation: {
                        type: Object
                    }
                }

            }

            static get observers() {
                return [
                    'updateDataFields(dataFieldsPrivate.*)'
                ]
            }

            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
                if (UtilsNew.isEmpty(this.prefix)) {
                    this.prefix = "repFilter" + Utils.randomString(6);
                }
                this.showPedigree = false;
                this.dataFieldsPrivate = {
                    reasonConsultation: "",
                    diseaseHeader: "",
                    applicant: "",
                    department: "",
                    city: "",
                    patient: "",
                    nuhsa: "",
                    familyNumber: "",
                    analysisType: "",
                    entryDate: "",
                    relationship: "",
                    depth: "",
                    extraInterpretation: "",
                    coverage: "",
                    signLeft: "",
                    signRight: "",
                    birthYear: ""
                };
            }

            connectedCallback(){
                super.connectedCallback();
                if (UtilsNew.isNotUndefinedOrNull(this.interpretation) && UtilsNew.isNotUndefinedOrNull(this.interpretation.attributes) && UtilsNew.isNotUndefinedOrNull(this.interpretation.attributes.panelInfo)) {
                    this.dataFieldsPrivate.reasonConsultation = this.interpretation.attributes.panelInfo.panel;
                    this.dataFieldsPrivate.diseaseHeader = this.interpretation.attributes.panelInfo.panel;
                    this.dataFieldsPrivate = Object.assign({},this.dataFieldsPrivate)
                }
                this.showReportOptions();
            }

            updateDataFields() {
                this.dataFields = Object.assign({},this.dataFieldsPrivate);
            }

            updateVariableSets() {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                    .then(function (response) {
                        _this.variableSets = response.response[0].result[0].variableSets;
                        if (_this.variableSets.length > 0) {
                            _this.variables = _this.variableSets[0].variables; // setting first one by default
                            _this.filteredVariables = {
                                variableSet: _this.variableSets[0].id,
                                variables: []
                            };
                        } else {
                            _this.variableSets = [{name: "none"}];
                        }
                    })
                    .catch(function () {
                        console.log("Could not obtain the variable sets of the study " + _this.study);
                    });
            }

            _sortVariables(a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            }

            sampleInfoField() {
                let field = PolymerUtils.getElementById(this.prefix + "SampleFields");
                let fields = PolymerUtils.querySelectorAll("input[type='checkbox']", field);
                let fieldsAux = [];
                if (fields.length > 0) {
                    for (let i = 0; i < fields.length; i++) {
                        fieldsAux.push({name: fields[i].value, value: fields[i].checked});
                    }
                }

                let _obj = Object.assign({}, this.selection, {sampleInfo: fieldsAux});
                this.selection = _obj;

            }

            sampleInfoAll() {
                let field = PolymerUtils.getElementById(this.prefix + "SampleFields");
                let fields = PolymerUtils.querySelectorAll("input[type='checkbox']", field);
                for (let i = 0; i < fields.length; i++) {
                    PolymerUtils.setPropertyById(fields[i].id, "checked", true);
                    PolymerUtils.setAttribute(fields[i].id, "disabled", true);
                }
                this.sampleInfoField();

            }

            sampleInfoSubset() {
                let field = PolymerUtils.getElementById(this.prefix + "SampleFields");
                let fields = PolymerUtils.querySelectorAll("input[type='checkbox']", field);
                for (let i = 0; i < fields.length; i++) {
                    PolymerUtils.removeAttribute(fields[i].id, "disabled");
                }
            }

            onExport() {
                this.expReport = true;

//                this.settingsMessageModal = {
//                    messageHeader: "Warning",
//                    messageBody: ["To be implemented"],
//                    type: "danger",
//                    height: "100px",
//                    width: "500px"
//                };
//                this.showMessageModal = true;
            }

            onSave() {
                this.settingsMessageModal = {
                    messageHeader: "Warning",
                    messageBody: ["To be implemented"],
                    type: "danger",
                    height: "100px",
                    width: "500px"
                };
                this.showMessageModal = true;
            }

            showReportOptions() {
//                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
//                    PolymerUtils.show(this.prefix + "PrioritizationInformationDiv");
//                    PolymerUtils.show(this.prefix + "OtherInformationDiv");
                if (UtilsNew.isNotUndefinedOrNull(this.analysisSelected)) {
                    this.showAnalysisSelecteDefault();
                    PolymerUtils.setValue(this.prefix + "FilterTextInput",this.analysisSelected.name);

                }
            }

            showAnalysisSelecteDefault(){
                PolymerUtils.show(this.prefix + "analysisSelectedDiv");
                PolymerUtils.show(this.prefix + "SampleInformationDiv");
                PolymerUtils.show(this.prefix + "analysisResumeDiv");


                this.currentAnalysisID = this.analysisSelected.analysisID;
                let _obj = Object.assign({}, this.selection, {analysisSelected: true});
                this.selection = _obj;
            }

            showAnalysisResume(e) {
                e.preventDefault();
                let _obj = Object.assign({}, this.selection, {analysisResume: e.target.checked});
                this.selection = _obj;
            }

            showPedigreeIn(e) {
                e.preventDefault();
                if (this.analysisSelected.type === "TRIO" || this.analysisSelected.type === "DUO" || this.analysisSelected.type === "FAMILY") {
                    let _obj = Object.assign({}, this.selection, {pedigree: e.target.checked});
                    this.selection = _obj;
                }
            }

            showPrioritization(e) {
                e.preventDefault();
                let field = PolymerUtils.getElementById(this.prefix + "PrioritizationFields");
                let fields = PolymerUtils.querySelectorAll("input[type='checkbox']", field);
                let fieldsAux = [];
                if (fields.length > 0) {
                    for (let i = 0; i < fields.length; i++) {
                        fieldsAux.push({name: fields[i].value, value: fields[i].checked});
                    }
                }

                let _obj = Object.assign({}, this.selection, {prioritizationInfo: fieldsAux});
                this.selection = _obj;
            }

            showAttached1(e) {
                e.preventDefault();
                let _obj = Object.assign({}, this.selection, {attached1: e.target.checked});
                this.selection = _obj;
            }
            showAttached2(e) {
                e.preventDefault();
                let _obj = Object.assign({}, this.selection, {attached2: e.target.checked});
                this.selection = _obj;
            }

            showConclusions(e) {
                e.preventDefault();
                let _obj = Object.assign({}, this.selection, {conclusions: e.target.checked});
                this.selection = _obj;
            }

//            showClinicalSelector(e) {
//                e.preventDefault();
//                if (UtilsNew.isUndefined(this.analysisModal)) {
//                    this.analysisModal = true;
//                }
//                else {
//                    this.analysisModal = !this.analysisModal;
//                }
//                //TODO Refactor
//                $(PolymerUtils.getElementById(this.prefix + "AnalysisBrowser")).modal('show');
//            }
        }

        customElements.define(VariantReportFilter.is, VariantReportFilter);

    </script>
</dom-module>