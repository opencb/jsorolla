<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="variant-report-view">
    <template>
        <style include="jso-styles">
            #variantTablebody,#variantTablebody td{
                border:1px solid #dadada;
                border-collapse:collapse
            }
            .clinical-input-group-addon{
                min-width:200px;
                text-align:left
            }
            #variantTable,#variantTable th,.tablaGenes,.tablaGenes th{
                text-align:center
            }
            .form-control:disabled{
                background-color:#fff;
                cursor:default
            }
            h3{
                color:#337ab7
            }
            textarea{
                width:95%;
                height:100px;
                margin-top:5px;
                resize:none;
                border:1px solid #d0d0d0
            }
            #variantTable{
                width:95%;
                font-size:14px
            }
            #variantTablebody td{
                padding:10px 0 0
            }
            .centerHeader{
                margin:0;
                font-size:16px;
                font-weight:600;
                padding-bottom:30px;
                text-transform:uppercase
            }
            .titlesAnalysis{
                font-size:larger;
                font-weight:550
            }
            .fontBody,.tablaGenes,span.col-form-control{
                font-size:14px
            }
            .hrReport{
                border:1px solid #555;
                width:89%;
                margin-bottom:22px
            }
            .tablaGenes td,.tablaGenes th{
                border:1px solid #000
            }
            .divSection{
                margin:-24px 0 5px 11px
            }
            .tablaGenes{
                width:300px;
                float:left;
                margin-top:10px;
                margin-right:5px
            }
            .tablaGenes th{
                background-color:#a9a9a9
            }
            .clean{
                clear:left
            }
            label.col-form-label{
                font-weight:600;
                font-size:14px;
                margin-bottom:0
            }
            .marginbreak{
                margin-bottom:25.5px
            }
            .sampleMargin{
                margin:0 0 0 30px
            }
            .logoSas{
                height:100px;
                margin:0 0 0 72px
            }
            .infoPos,.posContent{
                margin-left:55px
            }
            table{
                page-break-inside:auto
            }
            tr{
                page-break-inside:avoid;
                page-break-after:auto
            }
            @media all{
                .page-break{
                    display:none
                }
            }
            @media print{
                .page-break{
                    display:block;
                    page-break-before:always
                }
            }
        </style>

        <br>
        <div id="{{prefix}}reportDiv" class="panel panel-default">
            <div class="panel-body">
                <img src="[[importPath]]images/logosas.svg" class="logoSas">

                <hr class="hrReport">

                <div class="divSection sample-information col-sm-12 col-xs-12" id="{{prefix}}InfoFirstTab">
                    <!-- Sample information related to proband -->
                    <div class="sampleMargin">
                        <table class="analysis-information col-sm-10">
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}Applicant" class="col-form-label">{{loadi18n('applicant')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}Applicant" name="applicant">{{dataFields.applicant}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label class="col-form-label"></label>
                                    <span class$="col-form-control {{prefix}}TextInput">Sección de Genética y Genómica</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}department" class="col-form-label">{{loadi18n('department')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}department" name="date">{{dataFields.department}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label class="col-form-label"></label>
                                    <span class$="col-form-control {{prefix}}TextInput">UGC Medicina Maternofetal, Genética y Reproducción</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}ChromosomalGender" class="col-form-label">
                                        <b>{{loadi18n('hospital')}}:</b>
                                    </label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}ChromosomalGender" name="chromosomalGender">{{dataFieldsFixed.hospital}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label class="col-form-label"></label>
                                    <span class$="col-form-control {{prefix}}TextInput">HU Virgen del Rocío</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}city" class="col-form-label">
                                        <b>{{loadi18n('city')}}:</b>
                                    </label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}city" name="date">{{dataFields.city}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label class="col-form-label"></label>
                                    <span class$="col-form-control {{prefix}}TextInput">Avda. Manuel Siurot s/n, 41013 Sevilla</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <hr class="hrReport">

                <div class="divSection sample-information col-sm-12 col-xs-12" id="{{prefix}}InfoSecondTab">
                    <div class="sampleMargin">
                        <table class="analysis-information col-sm-10">
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}Patient" class="col-form-label">{{loadi18n('patient')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}Patient" name="patient">{{dataFields.patient}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}EntryDate" class="col-form-label">{{loadi18n('entryDate')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}EntryDate" name="entryDate">{{dataFields.entryDate}}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}nuhsa" class="col-form-label">{{loadi18n('nuhsa')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}nuhsa" name="nuhsa">{{dataFields.nuhsa}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}YearBirth" class="col-form-label">{{loadi18n('yearBirth')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}YearBirth" name="yearBirth">{{dataFields.birthYear}}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}adn" class="col-form-label">{{loadi18n('adn')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}adn" name="adn">{{dataFieldsFixed.sampleName}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}Sex" class="col-form-label">{{loadi18n('sex')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}Sex" name="sex">{{loadi18n(dataFieldsFixed.sex)}}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}Family" class="col-form-label">{{loadi18n('family')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}Family" name="family">{{dataFields.familyNumber}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}Relationship" class="col-form-label">{{loadi18n('relationship')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}Relationship" name="relationship">{{dataFields.relationship}} {{dataFields.extraRelationship}}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}AnalysisType" class="col-form-label">{{loadi18n('analysisType')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}AnalysisType" name="analysisType">{{dataFields.analysisType}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}Status" class="col-form-label">{{loadi18n('status')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}Status" name="status">{{loadi18n(dataFieldsFixed.affectationStatus)}}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}SampleType" class="col-form-label">{{loadi18n('sampleType')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}SampleType" name="sampleType">{{loadi18n(dataFieldsFixed.sampleType)}}</span>
                                </td>
                                <td class="col-xs-5 col-sm-5 col-md-5">
                                    <label for="{{prefix}}ReportDate" class="col-form-label">{{loadi18n('reportDate')}}:</label>
                                    <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}ReportDate" name="reportDate">{{requestDate}}</span>
                                </td>
                            </tr>
                        </table>

                        <div class="divSection sample-information col-sm-12" id="{{prefix}}analysisInformationFamilyDiv" hidden>
                            <h4> Family </h4>
                            <div style="margin: 10px 0px 15px 5px" class="analysis-information col-sm-10">
                                <div>
                                    <div id="{{prefix}}PedigreeView" style="padding: 5px 5px;font-size: 10px"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="hrReport">

                <!-- Disease Header -->
                <h3 id="{{prefix}}titleReport" class="centerHeader text-center" style=" width: 75%; margin: 0 auto; ">{{loadi18n('header')}} {{dataFields.diseaseHeader}}</h3>
                <div style="float: left;margin: 0px 0px 15px 70px;">
                    <h3 class="titlesAnalysis">{{loadi18n('reasonConsultation')}}</h3>
                    <p style="margin-left: 13px;">{{dataFields.reasonConsultation}}</p>
                </div>

                <br><br><br><br><br><div class="clean"></div><br>

                <div class="page-break marginbreak">
                    <img src="[[importPath]]images/logosas.svg" class="logoSas">
                </div>

                <!-- Prioritization Information -->
                <div class="divSection prioritization-information infoPos col-sm-12" id="{{prefix}}prioritizationInformationDiv">
                    <div style="padding-bottom: 25.5px;"></div>
                    <h3 class="titlesAnalysis">{{loadi18n('prioritizationInfo')}}</h3>
                    <hr>
                    <div class="prioritization-summary col-sm-10" id="{{prefix}}variantsTableDiv" hidden>
                        <!-- <h4 class="fontBody" style="font-weight: 600;">{{loadi18n('result')}}</h4> -->
                        <table id="variantTable" class="table hover" style="border: 1px solid #dadada;
                                border-collapse: collapse;">
                            <thead>
                                <tr class="active">
                                    <th>{{loadi18n('variant')}}</th>
                                    <th>{{loadi18n('snpId')}}</th>
                                    <th>{{loadi18n('genes')}}</th>
                                    <th>{{loadi18n('type')}}</th>
                                    <th>{{loadi18n('consequenceType')}}</th>
                                </tr>
                            </thead>
                            <tbody id="variantTablebody">
                            </tbody>
                        </table>
                    </div>

                    <!-- Prioritization Summary -->
                    <div class="prioritization-summary col-sm-10" id="{{prefix}}variantsResultDiv">
                        <table id="resultTable" class="table hover" style="border: 1px solid #dadada;
                                border-collapse: collapse;">
                            <tbody>
                                <template is="dom-if" if="{{!interpretation.attributes.panelInfo.positive}}">
                                    <tr class="active">
                                        <td>
                                            <strong class="fontBody">{{loadi18n('result')}}</strong>
                                        </td>
                                        <td class="fontBody">{{loadi18n('textResultNegative')}} {{dataFields.diseaseHeader}}</td>
                                    </tr>
                                </template>

                                <tr class="active">
                                    <td>
                                        <strong class="fontBody">{{loadi18n('summary')}}</strong>
                                    </td>
                                    <template is="dom-if" if="{{!interpretation.attributes.panelInfo.positive}}">
                                        <td class="fontBody">{{loadi18n('textSummaryNegative')}}</td>
                                    </template>
                                    <template is="dom-if" if="{{interpretation.attributes.panelInfo.positive}}">
                                        <td class="fontBody">
                                            <template is="dom-repeat" items="{{interpretation.reportedVariants}}">
                                                <!--let variantId  = data[j].chromosome + ":" + data[j].start + ":" + data[j].reference + ":" + data[j].alternate;-->
                                                <li>{{dataFields.patient}} presenta la mutación {{item.chromosome}}:{{item.start}}:{{item.reference}}:{{item.alternate}}
                                                    del gen {{genesRow(item)}} en {{zigosityResult(item.studies)}}</li>
                                            </template>
                                        </td>
                                    </template>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="prioritization-summary col-sm-12" id="{{prefix}}prioritizationSummaryDiv" hidden>
                        <h4>{{loadi18n('filterSummary')}}</h4>
                        <div class="form-group row">
                            <div class="col-xs-10">
                                <label for="{{prefix}}totalVariants" class="col-form-label">{{loadi18n('totalVariants')}}:</label>
                                <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}totalVariants" name="totalVariants" value="20"></span>
                            </div>
                            <div class="col-xs-10">
                                <label for="{{prefix}}diagnosticVariants" class="col-xs-2 col-form-label">{{loadi18n('diagnosticVariants')}}:</label>
                                <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}diagnosticVariants" name="diagnosticVariants" value="2"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-xs-10">
                                <label for="{{prefix}}vus" class="col-form-label">{{loadi18n('vus')}}</label>
                                <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}vus" name="totalVariants" value="2"></span>
                            </div>
                            <div class="col-xs-10">
                                <label for="{{prefix}}unexpectedVariants" class="col-xs-2 col-form-label">{{loadi18n('unexpectedVariants')}}:</label>
                                <span class$="col-form-control {{prefix}}TextInput" id="{{prefix}}unexpectedVariants" name="diagnosticVariants" value="1"></span>
                            </div>
                        </div>
                    </div>
                    <br>
                </div>

                <!-- Interpretation -->
                <template is="dom-if" if="{{!interpretation.attributes.panelInfo.positive}}">
                    <div class="divSection other-information posContent col-sm-12" id="{{prefix}}interpretationDiv">
                        <h3 class="titlesAnalysis">{{loadi18n('interpretationHeader')}}</h3>
                        <ul>
                            <li>
                                <span id="{{prefix}}interpretationText1">{{dataFields.patient}}({{dataFields.birthYear}})</span>{{loadi18n('interpretationText1')}}</li>
                            <li>{{loadi18n('interpretationText2_1')}} {{dataFields.depth}}{{loadi18n('interpretationText2_2')}}
                                {{dataFields.coverage}}{{loadi18n('interpretationText2_3')}}
                            </li>
                            <li>{{loadi18n('interpretationText3')}}</li>
                            <li>{{loadi18n('interpretationText4_1')}}{{dataFields.diseaseHeader}}{{loadi18n('interpretationText4_2')}}</li>
                        </ul>
                    </div>
                </template>

                <!-- Info positive -->
                <template is="dom-if" if="{{interpretation.attributes.panelInfo.positive}}">
                    <div class="divSection other-information col-sm-12 marginbreak" id="{{prefix}}interpretationDiv">
                        <h3 class="titlesAnalysis">{{loadi18n('interpretationHeader')}}</h3>
                        <ul>
                            <li>{{dataFields.extraInterpretation}}</li>
                            <li>{{dataFields.extraInterpretationComments}}</li>
                            <li>{{loadi18n('interpretationText2_1')}} {{dataFields.depth}}{{loadi18n('interpretationText2_2')}}
                                {{dataFields.coverage}}{{loadi18n('interpretationText2_3')}}
                            </li>
                            <li>{{loadi18n('interpretationText3')}}</li>
                            <li>{{loadi18n('interpretation1_positive')}}</li>
                        </ul>
                    </div>
                </template>

                <!-- Sign -->
                <div class="divSection other-information col-sm-12" id="{{prefix}}signDiv" style="margin-top:30px; padding-bottom:100px;">
                    <div class="row">
                        <div class="marginbreak" style="padding-top:50px;"></div>

                        <content class="col-xs-6" id="{{prefix}}signLeft">
                            <label class="col-form-label posContent" style="padding-left:20px;">{{loadi18n('signBy')}}{{dataFields.signLeft}}</label>
                        </content>
                        <content class="col-xs-6" id="{{prefix}}signRight">
                            <label class="col-form-label posContent" style="padding-left:20px;">{{loadi18n('signBy')}}{{dataFields.signRight}}</label>
                        </content>
                    </div>
                </div>

                <div class="page-break">
                    <img src="[[importPath]]images/logosas.svg" class="logoSas">
                </div>

                <!-- Methodology -->
                <div class="divSection other-information posContent col-sm-12" id="{{prefix}}methodologyDiv">
                    <br>
                    <h3 class="titlesAnalysis">{{loadi18n('methodology')}}</h3>
                    <br>
                    <ul>
                        <li>{{loadi18n('methodologyText1')}}</li>
                        <li>{{loadi18n('methodologyText2')}}</li>
                        <li>{{loadi18n('methodologyText3')}}
                            <ul>
                                <li>{{loadi18n('methodologyText3_1')}}</li>
                                <li>{{loadi18n('methodologyText3_2')}}</li>
                                <li>{{loadi18n('methodologyText3_3')}}</li>
                                <li>{{loadi18n('methodologyText3_4')}}</li>
                            </ul>
                        </li>
                        <li>{{loadi18n('methodologyText4')}}</li>
                    </ul>
                    <p>{{loadi18n('methodologyText5')}}</p>
                    <p>{{loadi18n('methodologyText6')}}</p>
                </div>

                <!-- Analysis Information -->
                <div class="divSection analysis-information infoPos col-sm-12" id="{{prefix}}analysisInformationDiv" hidden>

                    <br>
                    <h3 class="titlesAnalysis">{{loadi18n('otherInformation')}}</h3>
                    <!-- <h3 class="titlesAnalysis">{{loadi18n('headerAnalysis')}}</h3> -->

                    <div style="margin: 0px 0px 30px 0px" class="analysis-information col-sm-10" id="{{prefix}}analysisInformationContent">
                        <div class="row" id="{{prefix}}analysisInformation" hidden>
                            <div class="col-xs-6" id="{{prefix}}analysisInformationID">
                                <label for="{{prefix}}analysisID" class="col-form-label">{{loadi18n('analysisId')}}:</label>
                                <span class$="{{prefix}}TextInput" id="{{prefix}}analysisID" name="analysis"></span>
                            </div>

                            <div class="col-xs-6" id="{{prefix}}analysisDescription">
                                <label for="{{prefix}}Description" class="col-form-label">{{loadi18n('analysisDescription')}}:</label>
                                <span class$="{{prefix}}TextInput" id="{{prefix}}Description" name="description"></span>
                            </div>
                        </div>
                        <div class="row" id="{{prefix}}analysisInformationResume" hidden>
                            <content class="col-xs-6">
                                <label for="{{prefix}}analysisType" class="col-form-label">{{loadi18n('analysisType')}}:</label>
                                <span class$="{{prefix}}TextInput" id="{{prefix}}analysisType" name="analysisType"></span>
                            </content>
                            <content class="col-xs-6">
                                <label for="{{prefix}}date" class="col-form-label">{{loadi18n('analysisDate')}}:</label>
                                <span class$="col-form-label {{prefix}}TextInput" id="{{prefix}}date" name="date"></span>
                            </content>
                        </div>
                    </div>
                </div>

                <!-- Interpretation Information -->
                <div class="divSection posContent col-sm-12 marginbreak" id="{{prefix}}interpretationInformationDiv">
                    <!-- <h3 class="titlesAnalysis">{{loadi18n('interpretationInfo')}}</h3> -->

                    <div style="margin: 0px 0px 20px 0px" class="col-sm-10" id="{{prefix}}interpretationInformationContent">
                        <div class="row">

                            <content class="col-xs-6 fontBody" id="{{prefix}}interpretationInformationID">
                                <label for="{{prefix}}interpretationID" class="col-form-label">{{loadi18n('interpretationId')}}:</label>
                                <span class$="{{prefix}}TextInput" id="{{prefix}}interpretationID" name="interpretation"></span>
                            </content>
                            <content class="col-xs-6 fontBody" id="{{prefix}}interpretationInformationName">
                                <label for="{{prefix}}interpretationName" class="col-form-label">{{loadi18n('interpretationName')}}:</label>
                                <span class$="{{prefix}}TextInput" id="{{prefix}}interpretationName" name="interpretationName"></span>
                            </content>
                        </div>
                    </div>
                </div>

                <!-- Additional Info -->
                <div class="divSection other-information posContent col-sm-12" id="{{prefix}}conclusionsDiv" hidden>
                    <div style="padding-top:20px;"></div>
                    <div class="col-sm-10">
                        <textarea type="text" class$="form-control {{prefix}}TextInput autoExpand" id="{{prefix}}conclusions" name="conclusions"
                            placeholder="{{loadi18n('otherInformation')}}" rows="5" on-input="updateTextArea" on-focus="calculateHeightTextArea"
                            data-min-rows="5"></textarea>
                    </div>
                </div>

                <div class="page-break"></div>

                <!-- Attached -->
                <div class="divSection other-information col-sm-12" id="{{prefix}}attached1Div">
                    <br>
                    <h3 class="titlesAnalysis">{{loadi18n('attached1')}} - Secuencias de referencia de los genes incluidos en el estudio</h3>

                    <table class="tablaGenes">
                        <thead>
                            <tr class="active">
                                <th>{{loadi18n('gen')}}</th>
                                <th>{{loadi18n('reference')}}</th>
                            </tr>
                        </thead>
                        <tbody id="sequenceGeneTablebody">
                        </tbody>
                    </table>
                </div>

                <div class="clean"></div>

                <!-- Attached 2 -->
                <div class="divSection prioritization-information col-sm-12" id="{{prefix}}attached2Div" style="margin-top:50px;" hidden>
                    <div class="page-break"></div>
                    <h3 class="titlesAnalysis">{{loadi18n('attached2')}} - {{loadi18n('filterSummary')}}</h3>

                    <div class="prioritization-summary col-sm-12" id="{{prefix}}filterResumeDiv">
                        <!-- <h4>{{loadi18n('filterSummary')}}</h4> -->
                        <template is="dom-if" if="{{filters}}">
                            <div>
                                <br>
                                <ul type="disc">
                                    <template is="dom-repeat" items="{{filterPrioritization}}">
                                        <li>{{item.id}}:
                                            <i>{{_split(item.value)}}</i>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                        <template is="dom-if" if="{{!filters}}">
                            {{loadi18n('noFiltersApplied')}}
                        </template>
                    </div>
                </div>
            </div>
        </div>

    </template>
    <script>
        function splitTable(table, maxHeight) {
            let header = table.children("thead");
            if (!header.length)
                return;

            let headerHeight = header.outerHeight();
            header = header.detach();

            let splitIndices = [0];
            let rows = table.children("tbody").children();
            let numRows = rows.length;

            maxHeight -= headerHeight;
            let currHeight = 0;
            rows.each(function (i, row) {
                currHeight += $(rows[i]).outerHeight();
                if (currHeight > maxHeight) {
                    splitIndices.push(i);
                    currHeight = $(rows[i]).outerHeight();
                }
            });
            splitIndices.push(undefined);

            table = table.replaceWith('<div id="_split_table_wrapper"></div>');
            table.empty();

            for (let i = 0; i < splitIndices.length - 1; i++) {
                let newTable = table.clone();
                header.clone().appendTo(newTable);
                $('<tbody />').appendTo(newTable);
                rows.slice(splitIndices[i], splitIndices[i + 1]).appendTo(newTable.children('tbody'));
                newTable.appendTo("#_split_table_wrapper");
                if (splitIndices[i + 1] !== undefined) {
                    $('<div style="margin:0; padding:0; border: none;"></div>').appendTo("#_split_table_wrapper");
                }
            }
        }

        class VariantReportView extends Polymer.Element {
            static get is() {
                return 'variant-report-view';
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object
                    },
                    study: {
                        type: Object
                    },
                    prefix: {
                        type: String
                    },
                    config: {
                        type: Object
                    },
                    selection: {
                        type: Object,
                        observer: 'showSelection'
                    },
                    toolTitle: {
                        type: String,
                        value: ""
                    },
                    expReport: {
                        type: Boolean,
                        observer: 'handleExportPDF',
                        notify: true
                    },
                    variables: {
                        type: Array,
                        observer: 'loadVariableSet'

                    },
                    // analysisSelected: {
                    //     type: Object,
                    //     observer: 'loadData'
                    // },
                    interpretation: {
                        type: Object,
                        observer: 'loadData'

                    },
                    i18n: {
                        type: Object
                    },
                    dataFields: {
                        type: Object
                    },
                    mmpExtensionConfig: {
                        type: Object
                    }
                }
            }

            constructor() {
                super();
                this.prefix = "repView" + Utils.randomString(6);
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
                if (UtilsNew.isEmpty(this.prefix)) {
                }
                let date = new Date();
                let fecha  = date.toLocaleString('es-ES', { timeZone: 'UTC' });
                this.requestDate = fecha.substring(0, fecha.length - 8);
                this.fitlerPrioritization = {};
            }

            connectedCallback() {
                super.connectedCallback();
                this.loadVariableSet();
                this.loadData();
            }

            loadi18n(key) {
                if (UtilsNew.isNotUndefinedOrNull(this.i18n[key])) {
                    // if (this.i18n[key] instanceof Function) {
                    // let data = {};
                    // keys.forEach((key, i) => {
                    //     data[key] = this.dataFields[key];
                    // });
                    // return this.i18n[key](data);
                    // } else {
                    return this.i18n[key]
                    // }
                } else {
                    return "No exists key:" + key;
                }
            };

            zigosityResult(studies) {
                if (UtilsNew.isNotEmptyArray(studies) && UtilsNew.isNotUndefinedOrNull(studies[0]) && UtilsNew.isNotUndefinedOrNull(studies[0].samplesData)
                    && UtilsNew.isNotUndefinedOrNull(studies[0].samplesData[0])) {
                    let genotypes = studies[0].samplesData[0][0].split("/");
                    if (genotypes[0] !== genotypes[1]) {
                        return this.loadi18n('heterocigosis');
                    } else {
                        return this.loadi18n('homocigosis');
                    }
                }
                return "N/A";
            }

            loadData() {
                // Load data into report
                this.dataFieldsFixed = {
                };
                if (UtilsNew.isNotUndefined(this.selection && this.selection.analysisSelected)) {
                    if (UtilsNew.isNotUndefined(this.interpretation.clinicalAnalysis)) {
                        let patientId = this.interpretation.clinicalAnalysis.subjects[0].name;
                        let birthYear = this.interpretation.clinicalAnalysis.subjects[0].dateOfBirth;
                        let affectationStatus = this.interpretation.clinicalAnalysis.subjects[0].affectationStatus;
                        let sex = this.interpretation.clinicalAnalysis.subjects[0].sex;
                        let sampleType = this.interpretation.clinicalAnalysis.subjects[0].samples[0].type;
                        let sampleName = this.interpretation.clinicalAnalysis.subjects[0].samples[0].name;
                        this.dataFieldsFixed.hospital = this.getValueVariableSet('hospital');
                        this.dataFieldsFixed.birthYear = birthYear;
                        this.dataFieldsFixed.affectationStatus = affectationStatus;
                        this.dataFieldsFixed.sex = sex;
                        this.dataFieldsFixed.sampleType = sampleType;
                        this.dataFieldsFixed.sampleName = sampleName;

                        // Analysis ID and analysis resume
                        PolymerUtils.setPropertyById(this.prefix + "analysisID", "innerText", this.interpretation.clinicalAnalysis.id);
                        PolymerUtils.setPropertyById(this.prefix + "Description", "innerText", this.interpretation.clinicalAnalysis.description);
                        PolymerUtils.setPropertyById(this.prefix + "analysisType", "innerText", this.interpretation.clinicalAnalysis.type);
                        PolymerUtils.setPropertyById(this.prefix + "date", "innerText", moment(this.interpretation.clinicalAnalysis.creationDate, "YYYYMMDDHHmmss").format('D MMM YY'));
                        this.analysisID = this.interpretation.clinicalAnalysis.id;
                        PolymerUtils.setPropertyById(this.prefix + "interpretationID", "innerText", this.interpretation.id);
                        PolymerUtils.setPropertyById(this.prefix + "interpretationName", "innerText", this.interpretation.name);

                        // Sample Information
                        PolymerUtils.setPropertyById(this.prefix + "IndividualID", "innerText", patientId);
                        PolymerUtils.setPropertyById(this.prefix + "AffectationStatus", "innerText", affectationStatus);
                        PolymerUtils.setPropertyById(this.prefix + "BirthYear", "innerText", birthYear);
                        PolymerUtils.setPropertyById(this.prefix + "Ethnicity", "innerText", this.interpretation.clinicalAnalysis.subjects[0].ethnicity);
                        PolymerUtils.setPropertyById(this.prefix + "ChromosomalGender", "innerText", this.interpretation.clinicalAnalysis.subjects[0].karyotypicSex);
                        PolymerUtils.setPropertyById(this.prefix + "lifeStatus", "innerText", this.interpretation.clinicalAnalysis.subjects[0].lifeStatus);
                        PolymerUtils.setPropertyById(this.prefix + "ParentalConsanguinity", "innerText", this.interpretation.clinicalAnalysis.subjects[0].parentalConsanguinity ? "Yes" : "No");
                        PolymerUtils.setPropertyById(this.prefix + "birthPlace", "innerText", this.interpretation.clinicalAnalysis.subjects[0].population.name);
                        PolymerUtils.setPropertyById(this.prefix + "SampleID", "innerText", sampleName);

                        let HPODiseases = this.interpretation.clinicalAnalysis.subjects[0].phenotypes.filter((hpo) => {
                            return hpo.source === "HPO";
                        }).map((hpo) => hpo.name).join(",");
                        PolymerUtils.innerHTML(this.prefix + "HPO", HPODiseases);
                        let ICD10Diseases = this.interpretation.clinicalAnalysis.subjects[0].phenotypes.filter((icd) => {
                            return icd.source === "ICD10";
                        }).map((icd) => icd.name).join(",");
                        PolymerUtils.innerHTML(this.prefix + "Diagnosis", ICD10Diseases);
                        //
                        PolymerUtils.setPropertyById(this.prefix + "cellLine", "innerText", this.interpretation.clinicalAnalysis.subjects[0].samples[0].somatic ? "Somatic" : "Germline");
                        PolymerUtils.setPropertyById(this.prefix + "sampleType", "innerText", sampleType);

                        // Family information (pedigree) -> Only for FAMILY, TRIO or DUO
                        //                    if (this.interpretation.clinicalAnalysis.type === "TRIO" || this.interpretation.clinicalAnalysis.type=== "DUO" || this.interpretation.clinicalAnalysis.type === "FAMILY") {
                        //                        let querySelector = PolymerUtils.getElementById(this.prefix + "PedigreeView");
                        //                        if (querySelector.hasChildNodes()) {
                        //                            let item = querySelector.childNodes[0];
                        //                            querySelector.removeChild(item);
                        //                        }
                        //
                        //                        querySelector.appendChild(this.pedigreeRender(this.interpretation.clinicalAnalysis.family));
                        //                    }
                        // Prioritization information (variants)
                        if (UtilsNew.isNotUndefined(this.interpretation.reportedVariants)) {
                            this.loadVariantTable(this.interpretation.reportedVariants);
                        }

                        // Load attached genes/reference
                        this.sequenceGeneTablebody();
                        //  let _prioritization = this.interpretation.clinicalAnalysis.family.children[0].samples[0].attributes.PRIORITIZATION;
                        let _dataTable = [];
                        let _query = undefined;
                        if (UtilsNew.isNotUndefined(this.interpretation)) {
                            _dataTable = this.interpretation.reportedVariants;
                            _query = this.interpretation.filters;
                        }

                        let _this = this;
                        $(PolymerUtils.getElementById(this.prefix + "variantTable")).bootstrapTable('destroy');
                        $(PolymerUtils.getElementById(this.prefix + "variantTable")).bootstrapTable({
                            columns: _this._getTableColumns(),
                            data: _dataTable
                        });

                        // Filter information
                        if (UtilsNew.isNotUndefined(_query)) {
                            let _filters = $.map(_query, function (value, key) {
                                if (value !== "") {
                                    return [{ id: key, value: value }];
                                }
                            });
                            this.filterPrioritization = _filters;
                            this.filters = true;
                        } else {
                            this.filterPrioritization = "No filters were selected";
                            this.filters = false;
                        }
                    }

                    this.dataFieldsFixed = Object.assign({}, this.dataFieldsFixed);
                    this.showSelection();
                }
            }
            loadVariantTable(data) {
                let table = document.getElementById("variantTablebody");
                if (UtilsNew.isNotUndefinedOrNull(table)) {
                    let rows = "";
                    for (let j = 0; j < data.length; j++) {
                        let variantId = data[j].chromosome + ":" + data[j].start + ":" + data[j].reference + ":" + data[j].alternate;

                        rows += '<tr><td>' + variantId + '</td><td>' + this._variantParamValue(data[j].id)
                            + '</td><td>' + this.genesRow(data[j]) + '</td><td>' + this._variantParamValue(data[j].type)
                            + '</td><td>' + this._variantParamValue(data[j].annotation.displayConsequenceType) + '</td></tr>';

                    }
                    table.innerHTML = rows;
                }
            }

            sequenceGeneTablebody() {
                let table = document.getElementById("sequenceGeneTablebody");
                let genes = this.interpretation.filters['gene'];

                if (UtilsNew.isNotUndefinedOrNull(table) && UtilsNew.isNotUndefinedOrNull(genes)) {
                    genes = genes.split(",");
                    let rows = "";
                    let promises = [];
                    genes.forEach((gene) => {
                        var url = new URL(this.mmpExtensionConfig.root + this.mmpExtensionConfig.gene + "findByName");
                        url.searchParams.append("name", gene);

                        let promiseA = fetch(url, {
                            method: 'get',
                            headers: {
                                'Accept': 'application/json'
                            }
                        })
                            .then((response) => {
                                return response.json();
                            }).then((response) => {
                                if (UtilsNew.isNotUndefinedOrNull(response.data)) {
                                    let reference = UtilsNew.isNotUndefinedOrNull(response.data.reference) ? response.data.reference : "N/A";
                                    let row = `
                                <tr>
                                    <td><i>${response.data.hgnc}</i></td>
                                    <td>${reference}</td>
                                </tr>
                                `;
                                    rows += row;
                                    table.innerHTML = rows;
                                }
                            });
                        promises.push(promiseA);
                    });

                    Promise.all(promises).then((pum) => {
                        $(function () { splitTable($(".tablaGenes"), 800); });
                    });
                }
            }

            _variantParamValue(param) {
                if (UtilsNew.isNotUndefined(param)) {
                    return param;
                } else {
                    return "";
                }
            }

            loadVariableSet() {
                this.variableSetMap = {};
                let _this = this;
                this.interpretation.clinicalAnalysis.subjects[0].samples[0].annotationSets[0].annotations.forEach((annotation) => {
                    _this.variableSetMap[annotation.name] = annotation.value;
                });
            }

            getValueVariableSet(key) {
                return this.variableSetMap[key];
            }

            showSelection() {
                // Analysis ID
                if (UtilsNew.isNotUndefined(this.selection && this.selection.analysisSelected)) {
                    PolymerUtils.removeAttribute(this.prefix + "sampleInformationDiv", "hidden");
                    PolymerUtils.removeAttribute(this.prefix + "analysisInformation", "hidden");
                    PolymerUtils.removeAttribute(this.prefix + "analysisInformationDiv", "hidden")
                }

                // Family information (pedigree) -> Only for FAMILY, TRIO or DUO
                if (UtilsNew.isNotUndefined(this.selection && this.selection.pedigree)) {

                    PolymerUtils.setPropertyById(this.prefix + "analysisInformationFamilyDiv", "hidden", !this.selection.pedigree);
                    // Family information (pedigree) -> Only for FAMILY, TRIO or DUO
                    if (this.selection.pedigree && (this.interpretation.clinicalAnalysis.type === "TRIO" || this.interpretation.clinicalAnalysis.type === "DUO" || this.interpretation.clinicalAnalysis.type === "FAMILY")) {
                        let querySelector = PolymerUtils.getElementById(this.prefix + "PedigreeView");
                        if (querySelector.hasChildNodes()) {
                            let item = querySelector.childNodes[0];
                            querySelector.removeChild(item);
                        }
                        querySelector.appendChild(this.pedigreeRender(this.interpretation.clinicalAnalysis.family));
                    }
                }
                //

                // Analysis resume
                if (UtilsNew.isNotUndefined(this.selection.analysisResume)) {
                    PolymerUtils.setPropertyById(this.prefix + "analysisInformationResume", "hidden", !this.selection.analysisResume)
                }

                // attached1
                if (UtilsNew.isNotUndefined(this.selection.attached1)) {
                    PolymerUtils.setPropertyById(this.prefix + "attached1Div", "hidden", !this.selection.attached1)
                }

                // attached2
                if (UtilsNew.isNotUndefined(this.selection.attached2)) {
                    PolymerUtils.setPropertyById(this.prefix + "attached2Div", "hidden", !this.selection.attached2)
                }

                // Sample Information
                if (UtilsNew.isNotUndefined(this.selection.sampleInfo)) {
                    for (let i = 0; i < this.selection.sampleInfo.length; i++) {
                        if (this.selection.sampleInfo[i].value) {
                            PolymerUtils.show(this.prefix + this.selection.sampleInfo[i].name + "Div");
                        } else {
                            PolymerUtils.hide(this.prefix + this.selection.sampleInfo[i].name + "Div");
                        }
                    }
                }

                // Editable conclusions
                if (UtilsNew.isNotUndefined(this.selection.conclusions)) {
                    PolymerUtils.setPropertyById(this.prefix + "conclusionsDiv", "hidden", !this.selection.conclusions);
                }
                //

                // Prioritization Information
                if (UtilsNew.isNotUndefined(this.selection.prioritizationInfo)) {
                    let _numFalseElements = 0;
                    for (let i = 0; i < this.selection.prioritizationInfo.length; i++) {
                        if (this.selection.prioritizationInfo[i].name == 'variantsTable' && this.selection.prioritizationInfo[i].value &&
                            PolymerUtils.getElementById(this.prefix + this.selection.prioritizationInfo[i].name + "Div").hidden) {
                            //$('#' + this.prefix + 'variantsClassificationModal').modal("show");
                        }
                        PolymerUtils.setPropertyById(this.prefix + this.selection.prioritizationInfo[i].name + "Div", "hidden", !this.selection.prioritizationInfo[i].value);

                        if (this.selection.prioritizationInfo[i].value == false) {
                            _numFalseElements++;
                        }
                    }

                    if (_numFalseElements == this.selection.prioritizationInfo.length) {
                        PolymerUtils.setAttribute(this.prefix + "prioritizationInformationDiv", "hidden", true);
                    }
                    else {
                        PolymerUtils.removeAttribute(this.prefix + "prioritizationInformationDiv", "hidden");
                    }
                }

                if (UtilsNew.isNotUndefinedOrNull(this.interpretation) && UtilsNew.isNotUndefinedOrNull(this.interpretation.attributes.panelInfo.positive)
                    && UtilsNew.isNotUndefinedOrNull(this.interpretation.attributes.panelInfo) && this.interpretation.attributes.panelInfo.positive) {
                    PolymerUtils.removeAttribute(this.prefix + "variantsTableDiv", "hidden");
                }
            }

            print(data) {
                var mywindow = window.open('', '', 'height=1000,width=1000');
                mywindow.document.write('<html><head>');
                var styles = document.getElementsByTagName('style');

                mywindow.document.write('<style>');
                for (var i = 0; i < styles.length; i++) {
                    mywindow.document.write(styles[i].innerHTML);
                }
                mywindow.document.write('</style>');

                mywindow.document.write('</head><body>');
                mywindow.document.write(data);
                mywindow.document.write('</body></html>');

                mywindow.document.close(); // necessary for IE >= 10
                mywindow.focus(); // necessary for IE >= 10
                mywindow.print();
                mywindow.close();
                return true;
            }

            _getTextInfo() {
                let sampleInfo = PolymerUtils.getElementById(this.prefix + "sampleInformationDiv");
                let elem = PolymerUtils.querySelectorAll("input", sampleInfo);
                let reportFields = [];
                for (var i = 0; i < elem.length; i++) {
                    reportFields.push({ name: elem[i].name, value: elem[i].value });
                }
                this.reportFields = reportFields;

            }

            handleExportPDF(e) {
                if (this.expReport) {
                    let report = document.getElementById(this.prefix + "reportDiv");
                    this.print(report.innerHTML);
                    this.expReport = false; // Reset export report button again
                }
                return;

            }

            _sortVariables(a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            }

            checkSubType(myVar, type) {
                return (myVar.attributes.subtype === type);
            }

            updateTextArea(e) {
                PolymerUtils.innerHTML(this.prefix + "conclusions", PolymerUtils.getValue(this.prefix + "conclusions"));

                // Dynamically change the height of the text area
                let minRows = e.target.getAttribute('data-min-rows');
                e.target.rows = minRows;
                let targetRows = Math.ceil((e.target.scrollHeight - this.baseScrollHeightTextArea) / 16);
                e.target.rows = parseInt(minRows) + parseInt(targetRows);
            }

            calculateHeightTextArea(e) {
                if (UtilsNew.isUndefinedOrNull(this.baseScrollHeightTextArea)) {
                    this.baseScrollHeightTextArea = e.target.scrollHeight;
                }
            }

            _getVariantsInfo(variants) {
                let _myVariants = [];
                for (let i = 0; i < variants.length; i++) {
                    _myVariants.push({
                        variant: variants[i].id,
                        genes: variants[i].annotation.consequenceTypes[0].geneName,
                        type: variants[i].type,
                        consequenceType: variants[i].annotation.consequenceTypes[0].sequenceOntologyTerms[0].name
                    });
                }
                return _myVariants;
            }

            genesRow(row) {
                let genes = [];
                for (let o in row.annotation.consequenceTypes) {
                    if (UtilsNew.isNotUndefined(row.annotation.consequenceTypes[o].geneName) && !genes.includes(row.annotation.consequenceTypes[o].geneName)) {
                        genes.push(row.annotation.consequenceTypes[o].geneName);
                    }
                }
                return genes;
            }

            pedigreeRender(body) {
                if (UtilsNew.isNotUndefinedOrNull(this.interpretation.clinicalAnalysis) && UtilsNew.isNotUndefinedOrNull(this.interpretation.clinicalAnalysis.family)) {
                    //  if (UtilsNew.isNotUndefined(this.svg)) {
                    //  PolymerUtils.getElementById(this.prefix + "PedigreeView").removeChild(this.svg);
                    //  }
                    let body = Object.assign({}, this.interpretation.clinicalAnalysis.family);
                    let membersNew = [];
                    body.members.forEach((member) => {
                        let newMember = Object.assign({}, member);
                        if (UtilsNew.isNotUndefinedOrNull(newMember.father) && UtilsNew.isNotUndefinedOrNull(newMember.father.id)) {
                            let newFather = body.members.find((member) => {
                                return member.id === newMember.father.id;
                            });
                            if (UtilsNew.isNotUndefinedOrNull(newFather)) {
                                newMember.father = newFather.name;
                            }
                        }

                        if (UtilsNew.isNotUndefinedOrNull(newMember.mother) && UtilsNew.isNotUndefinedOrNull(newMember.mother.id)) {
                            let newMother = body.members.find((member) => {
                                return member.id === newMember.mother.id;
                            });
                            if (UtilsNew.isNotUndefinedOrNull(newMother)) {
                                newMember.mother = newMother.name;
                            }
                        }
                        membersNew.push(newMember);
                    });
                    body.members = membersNew;

                    // Render new Pedigree
                    let pedigree = new Pedigree(body, { selectShowSampleNames: true });
                    this.svg = pedigree.pedigreeFromFamily(pedigree.pedigree, {
                        width: 200,
                        height: 180
                    });
                    return this.svg;
                }
            }
            _getTableColumns() {
                this._columns = [
                    [
                        {
                            title: 'Variant',
                            field: 'variant'
                        },
                        {
                            title: 'SNP Id',
                            field: 'id'
                        },
                        {
                            title: 'Genes',
                            field: 'genes'
                        },
                        {
                            title: 'Type',
                            field: 'type'
                        },
                        {
                            title: 'Consequence Type',
                            field: 'consequenceType'
                        }
                    ]
                ];
                return this._columns;
            }
            _split(value) {
                let spacers = [',', ';'];
                return (value).split(new RegExp(spacers.join('|'), 'g')).join(", ")
            }
        }
        customElements.define(VariantReportView.is, VariantReportView);
    </script>
</dom-module>