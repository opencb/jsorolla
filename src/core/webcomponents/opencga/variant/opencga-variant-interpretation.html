<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="opencga-variant-filter.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="opencga-variant-grid.html">
<link rel="import" href="../../cellbase/variation/cellbase-variantannotation-view.html">
<link rel="import" href="variant-beacon-network.html">
<link rel="import" href="variant-genome-browser.html">
<link rel="import" href="../clinical/clinical-analysis-view.html">
<link rel="import" href="../clinical/clinical-interpretation-view.html">


<dom-module id="opencga-variant-interpretation">
    <template>
        <style include="jso-styles">
            .prioritization-center {
                margin: auto;
                text-align: justify;
                width: 95%;
            }

            .prioritization-variant-tab-title {
                font-size: 115%;
                font-weight: bold;
            }

            .icon-padding {
                padding-left: 4px;
                padding-right: 8px;
            }
        </style>

        <template is="dom-if" if="{{checkProjects}}">
            <div class="panel" style="margin-bottom: 15px">
                <h3 style="margin: 10px 10px 10px 15px">
                     <span on-click="onCollapse" style="cursor: pointer;margin: 0px 30px 0px 0px">
                        <i class="fa fa-bars" aria-hidden="true"></i>
                    </span>
                    <i class="fa fa-filter" aria-hidden="true"></i>&nbsp;{{config.title}}
                </h3>
            </div>

            <!--<div class="row">-->
            <div class="row" style="padding: 0px 5px">
                <div>
                    <!--<template is="dom-if" if="{{interactive}}" on-dom-change="interactiveObserver">-->
                    <div id="{{prefix}}FilterMenu" class$="{{filterClass}}">
                        <opencga-variant-filter opencga-session="{{opencgaSession}}"
                                                family="[[family]]"
                                                opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}" config="{{config}}"
                                                population-frequencies="{{populationFrequencies}}"
                                                consequence-types="{{consequenceTypes}}" query="{{query}}" search="{{search}}"
                                                on-samplechange="onSampleChange"
                                                on-inheritancemode="_onInheritanceMode" mode-inheritance="{{modeInheritance}}">
                        </opencga-variant-filter>
                    </div>
                    <!--</template>-->

                    <div id="{{prefix}}MainWindow" class$="{{gridClass}}">

                        <opencga-active-filters opencga-client="{{opencgaClient}}" query="[[query]]" filters="{{config.filters}}" on-filterchange="onFilterChange" on-clear="onClear"
                                                filter-bioformat="VARIANT" default-study="{{opencgaSession.study.alias}}" alias="{{activeFilterAlias}}" refresh="{{search}}" genotype-samples="{{genotypeSamples}}"
                                                mode-inheritance="[[modeInheritance]]">
                        </opencga-active-filters>


                        <div class="col-md-12" style="padding: 5px 0px 5px 0px">
                            <div class="btn-toolbar" role="toolbar" aria-label="..." style="padding: 10px 0px">
                                <div class="btn-group" role="group" aria-label="..." >
                                    <button type="button" class="btn btn-success variant-interpretation-view-buttons active" data-view="TableResult" on-click="_changeView">
                                        <i class="fa fa-table icon-padding" aria-hidden="true" data-view="TableResult" on-click="_changeView"></i>Table Result
                                    </button>
                                    <button type="button" class="btn btn-success variant-interpretation-view-buttons" data-view="GenomeBrowser" on-click="_changeView">
                                        <i class="fa fa-list-alt icon-padding" aria-hidden="true" data-view="GenomeBrowser" on-click="_changeView"></i>Genome Browser (Beta)
                                    </button>
                                </div>

                                <div style="float: right">
                                    <div class="btn-group" role="group" aria-label="..." style="padding: 0px 5px">
                                        <button type="button" class="hidden btn btn-success variant-interpretation-view-buttons" data-view="ClinicalData" on-click="_changeView">
                                            <i class="fa fa-user-md icon-padding" aria-hidden="true" data-view="ClinicalData" on-click="_changeView"></i>Analysis and Clinical Data
                                        </button>
                                    </div>

                                    <div class="btn-group" role="group" aria-label="...">
                                        <template is="dom-if" if="{{clinicalAnalysis}}">
                                            <div class="btn-group" role="group" aria-label="...">
                                                <button id="{{prefix}}BackToAnalysisSelector" type="button" class="btn btn-primary variant-interpretation-view-buttons"
                                                        data-view="OpenClinicalAnalysis" on-click="_backToSelectAnalysis">
                                                    <i class="fa fa-arrow-left icon-padding" aria-hidden="true" data-view="OpenClinicalAnalysis" on-click="_backToSelectAnalysis"></i>Back to Clinical Analysis Selector
                                                </button>
                                            </div>
                                        </template>
                                        <button id="{{prefix}}OpenClinicalButton" type="button" class="hidden btn btn-primary variant-interpretation-view-buttons"
                                                data-view="OpenClinicalAnalysis" on-click="_changeView">
                                            <i class="fa fa-search icon-padding" aria-hidden="true" data-view="OpenClinicalAnalysis" on-click="_changeView"></i>Clinical Analysis
                                        </button>
                                        <button id="{{prefix}}SaveInterpretationButton" type="button" class="btn btn-primary variant-interpretation-view-buttons"
                                                data-view="SaveInterpretation" on-click="_changeView" disabled>
                                            <i class="fa fa-floppy-o icon-padding" aria-hidden="true" data-view="SaveInterpretation" on-click="_changeView"></i>Save Interpretation...
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <!-- TABLE RESULT -->
                            <div id="{{prefix}}TableResult" class="variant-interpretation-content">
                                <template is="dom-if" if="{{interactive}}">
                                    <!-- Variant Browser Grid -->
                                    <opencga-variant-grid opencga-session="{{opencgaSession}}" samples="{{samples}}"
                                                          opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"
                                                          population-frequencies="{{populationFrequencies}}"
                                                          protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                          consequence-types="{{consequenceTypes}}"
                                                          query="[[query]]" search="[[search]]" variant="{{variant}}"
                                                          on-selected="selectedGene" on-selectvariant="onSelectVariant" on-checkvariant="onCheckVariant"
                                                          show-select="{{config.grid.showSelect}}" style="font-size: 12px" config="{{config}}">
                                    </opencga-variant-grid>
                                </template>
                                <template is="dom-if" if="{{!interactive}}">
                                    <!-- Variant Browser Grid -->
                                    <opencga-variant-grid opencga-session="{{opencgaSession}}" samples="{{samples}}"
                                                          opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"
                                                          population-frequencies="{{populationFrequencies}}"
                                                          protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                          consequence-types="{{consequenceTypes}}"
                                                          query="[[defaultAutomaticQuery]]" search="[[search]]" variant="{{variant}}"
                                                          on-selected="selectedGene" on-selectvariant="onSelectVariant" on-checkvariant="onCheckVariant"
                                                          show-select="{{config.grid.showSelect}}" style="font-size: 12px" config="{{config}}">
                                    </opencga-variant-grid>
                                </template>

                                <!-- Bottom tabs with specific variant information -->
                                <div style="padding-top: 20px" hidden$="{{!checkVariant(variant)}}">
                                    <h3>Variant: {{variant}}</h3>
                                    <div style="padding-top: 20px">
                                        <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
                                            <li role="presentation" class="active">
                                                <a href="#{{prefix}}Annotation" role="tab" data-toggle="tab" class="prioritization-variant-tab-title">
                                                    Advanced Annotation
                                                </a>
                                            </li>
                                            <li role="presentation">
                                                <a href="#{{prefix}}FileMetrics" role="tab" data-toggle="tab" class="prioritization-variant-tab-title">
                                                    File Metrics
                                                </a>
                                            </li>
                                            <li role="presentation">
                                                <a href="#{{prefix}}Beacon" role="tab" data-toggle="tab" class="prioritization-variant-tab-title">
                                                    Beacon Network
                                                </a>
                                            </li>
                                        </ul>

                                        <div class="tab-content" style="height: 680px">
                                            <!--Annotation Tab-->
                                            <div role="tabpanel" class="tab-pane active" id="{{prefix}}Annotation">
                                                <cellbase-variantannotation-view data="{{variant}}" prefix="{{prefix}}"
                                                                                 cellbase-client="{{cellbaseClient}}"
                                                                                 mode="vertical"
                                                                                 hash-fragment-credentials="{{hashFragmentCredentials}}"
                                                                                 consequence-types="{{consequenceTypes}}"
                                                                                 protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                                 style="font-size: 12px">
                                                </cellbase-variantannotation-view>
                                            </div>

                                            <!-- File Metrics Tab -->
                                            <div id="{{prefix}}FileMetrics" role="tabpanel" class="tab-pane">
                                                <div class="col-md-8 col-md-offset-1" style="padding-top: 20px;overflow: auto;">
                                                    <table class="table table-hover">
                                                        <thead>
                                                        <tr>
                                                            <th>VCF Attribute</th>
                                                            <template is="dom-repeat" items="{{clinicalAnalysis.family.members}}" as="member">
                                                                <th>{{member.name}}</th>
                                                            </template>
                                                        </tr>
                                                        </thead>
                                                        <tbody id="{{prefix}}TableTBody">
                                                        <template is="dom-repeat" items="{{_getFileMetricsArray(variantObj.studies.0.files)}}" as="attrs">
                                                            <tr id="{{attrs.name}}" class$="file-metrics-table-{{attrs.name}}">
                                                                <td><span style="font-weight: bold">{{attrs.name}}</span></td>
                                                                <template is="dom-repeat" items="{{attrs.values}}" as="attr">
                                                                    <td>{{attr}}</td>
                                                                </template>
                                                            </tr>
                                                        </template>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            <!--Beacon network-->
                                            <div role="tabpanel" class="tab-pane" id="{{prefix}}Beacon">
                                                <br>
                                                <button class="btn btn-primary" type="button" on-click="triggerBeacon">Search Beacon
                                                    Network
                                                </button>
                                                <a data-toggle="tooltip"
                                                   title="Beacon Network is a search engine across the world's public beacons. You can find it here - https://beacon-network.org/#/"><i
                                                        class="fa fa-info-circle" aria-hidden="true"></i></a>
                                                <br><br>
                                                <variant-beacon-network hosts="{{beaconHosts}}" clear="{{variant}}"variant="{{variantToBeacon}}"></variant-beacon-network>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- GENOME BROWSER -->
                            <div id="{{prefix}}GenomeBrowser" class="variant-interpretation-content" style="display: none">
                                <br>
                                <br>
                                <variant-genome-browser opencga-session="{{opencgaSession}}"  samples="{{samples}}" opencga-client="{{opencgaClient}}"
                                                        cellbase-client="{{cellbaseClient}}" query={{query}} search={{search}} region="{{region}}"
                                                        active="{{_genomeBrowserActive}}" full-screen="{{fullScreen}}">
                                </variant-genome-browser>
                            </div>

                            <!-- ANALYSIS AND CLINICAL DATA -->
                            <div id="{{prefix}}ClinicalData" class="variant-interpretation-content" style="display: none">
                                <br>
                                <!--<opencga-sample-comparator opencga-client="{{opencgaClient}}" samples="{{samples}}"-->
                                <!--variable-sets="{{variableSets}}">-->
                                <!--</opencga-sample-comparator>-->
                                <clinical-analysis-view clinical-analysis={{clinicalAnalysis}} opencga-session="{{opencgaSession}}" opencga-client="{{opencgaClient}}" config="{{config}}"
                                                        class="col-md-10 col-md-offset-1" style="font-size: 12px">
                                </clinical-analysis-view>
                            </div>

                            <!-- SAVE INTERPRETATION TAB -->
                            <div id="{{prefix}}SaveInterpretation" class="variant-interpretation-content" style="display: none">
                                <div class="col-md-12">
                                    <h2 class="clinical-title">Save Interpretation</h2>
                                    <hr style="margin-top: 5px">
                                    <template is="dom-if" if="{{messageError}}">
                                        <div class="alert alert-danger" role="alert" id="{{prefix}}messageError" style="margin:5px auto;">{{messageErrorText}}</div>
                                    </template>
                                    <template is="dom-if" if="{{messageSuccess}}">
                                        <div class="alert alert-success" role="alert" id="{{prefix}}messageSuccess" style="margin:5px auto;">{{messageSuccessText}}</div>
                                    </template>
                                </div>
                                <div class="col-md-12">
                                    <form id="{{prefix}}uploadForm" class="form-horizontal" data-toggle="validator" data-feedback='{"success": "fa-check", "error": "fa-times"}' role="form">
                                        <!-- GENERAL INFORMATION -->
                                        <!-- ID -->
                                        <div class="form-group has-feedback">
                                            <label for="{{prefix}}IDInterpretation" class="col-md-2 col-form-label">ID</label>
                                            <div class="col-md-8">
                                                <div class="input-group">
                                                    <input type="text" class$="form-control {{prefix}}TextInput codeDis"
                                                           id="{{prefix}}IDInterpretation" name="ID" placeholder="ID of this interpretation ..."
                                                           maxlength="50" required data-error="" pattern=".+" style="width: 240px">
                                                    <!--<span class="input-group-addon btn btn-primary" on-click="searchIndividual">-->
                                                    <!--<i class="fa fa-search" aria-hidden="true"></i>-->
                                                    <!--</span>-->
                                                </div>
                                                <span class="fa form-control-feedback" aria-hidden="true" style="padding-right:60px; z-index:5"></span>
                                                <div class="help-block with-errors"></div>
                                            </div>
                                        </div>

                                        <!-- NAME -->
                                        <div class="form-group has-feedback">
                                            <label for="{{prefix}}NameInterpretation" class="col-md-2 col-form-label">Name</label>
                                            <div class="col-md-8">
                                                <div class="input-group">
                                                    <input type="text" class$="form-control {{prefix}}TextInput codeDis"
                                                           id="{{prefix}}NameInterpretation" name="Name" placeholder="Name of this interpretation ..."
                                                           maxlength="50" required data-error="" pattern=".+" style="width: 240px">
                                                    <!--<span class="input-group-addon btn btn-primary" on-click="searchIndividual">-->
                                                    <!--<i class="fa fa-search" aria-hidden="true"></i>-->
                                                    <!--</span>-->
                                                </div>
                                                <span class="fa form-control-feedback" aria-hidden="true" style="padding-right:60px; z-index:5"></span>
                                                <div class="help-block with-errors"></div>
                                            </div>
                                        </div>

                                        <!-- DESCRIPTION -->
                                        <div class="form-group has-feedback">
                                            <label for="{{prefix}}DescriptionInterpretation" class="col-md-2 col-form-label">Description</label>
                                            <div class="col-md-8">
                                                <div class="input-group">
                                                    <input type="text" class$="form-control {{prefix}}TextInput codeDis"
                                                           id="{{prefix}}DescriptionInterpretation" name="Name" placeholder="Description of this interpretation ..."
                                                           maxlength="250" required data-error="" pattern=".+" style="width: 480px">
                                                </div>
                                                <span class="fa form-control-feedback" aria-hidden="true" style="padding-right:60px; z-index:5"></span>
                                                <div class="help-block with-errors"></div>
                                            </div>
                                        </div>

                                        <!-- COMMENT -->
                                        <div class="form-group has-feedback">
                                            <label for="{{prefix}}CommentInterpretation" class="col-md-2 col-form-label">Comment</label>
                                            <div class="col-md-8">
                                                <div class="input-group">
                                                    <input type="text" class$="form-control {{prefix}}TextInput codeDis"
                                                           id="{{prefix}}CommentInterpretation" name="Name" placeholder="Add a comment ..."
                                                           maxlength="250" required data-error="" pattern=".+" style="width: 480px">
                                                </div>
                                                <span class="fa form-control-feedback" aria-hidden="true" style="padding-right:60px; z-index:5"></span>
                                                <div class="help-block with-errors"></div>
                                            </div>
                                        </div>

                                        <div class="form-group row" style="padding-left: 240px;">
                                            <button type="button" class="btn btn-primary" on-click="onViewInterpretation">View</button>
                                            <button type="button" class="btn btn-primary" on-click="onSaveInterpretation">Save</button>
                                        </div>

                                    </form>
                                </div>

                                <div class="col-md-12">
                                    <template is="dom-if" if="{{interpretationView}}">
                                        <clinical-interpretation-view id="id" interpretation="{{interpretationView}}" opencga-session="{{opencgaSession}}" opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"
                                                                      consequence-types="{{consequenceTypes}}" protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                      style="font-size: 12px">
                                        </clinical-interpretation-view>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <template is="dom-if" if="{{!checkProjects}}">
            <span style="text-align: center"><h3>No public projects available to browse. Please login to continue</h3></span>
        </template>

    </template>

    <script>
        class OpencgaVariantInterpretation extends Polymer.Element {

            constructor() {
                super();

                // Set status and init private properties
                this._init();
            }

            static get is() {
                return 'opencga-variant-interpretation';
            }

            static get properties() {
                return {
                    opencgaSession: {
                        type: Object
                    },
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    clinicalAnalysisId: {
                        type: String,
                        observer: 'clinicalAnalysisIdObserver',
                    },
                    clinicalAnalysis: {
                        type: Object,
                        observer: 'clinicalAnalysisObserver',
                        notify: true
                    },
                    diseasePanelId: {
                        type: String,
                        observer: "diseasePanelIdObserver"
                    },
                    beaconHosts: {
                        type: Array
                    },
                    query: {
                        type: Object
                    },
                    search: {
                        type: Object
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    proteinSubstitutionScores: {
                        type: Object
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    checkProjects: {
                        type: Boolean,
                        computed: '_checkProjects()'
                    },
                    interactive: {
                        type: Boolean,
                        observer: "interactiveObserver"
                    },
                    config: {
                        type: Object
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                if (!this.interactive) {
                    this.collapseFilter();
                }
            }

            _init() {
                this.prefix = "varPrior-" + Utils.randomString(6);

                this.interactive = true;
                this.filterClass = "col-md-2";
                this.gridClass = "col-md-10";


                this._collapsed = true;
                this.resultsViewActive = true;
                this.activeFilterAlias = {
                    "annot-xref": "XRef",
                    "annot-biotype": "Biotype",
                    "annot-ct": "Consequence Types",
                    "alternate_frequency": "Population Frequency",
                    "annot-functional-score": "CADD",
                    "protein_substitution": "Protein Substitution",
                    "annot-go": "GO",
                    "annot-hpo": "HPO"
                };

                this.messageError = false;
                this.messageSuccess = false;

                this.samples = [];
                this.family = {};

                this.defaultAutomaticQuery = {
                    biotype: "protein_coding"
                };
            }

            clinicalAnalysisIdObserver() {
                let _this = this;
                this.opencgaClient.clinical().info(this.clinicalAnalysisId, {})
                    .then((response) => {
                        // this must call to clinicalAnalysisObserver function
                        _this.clinicalAnalysis = response.response[0].result[0];
                    })
                    .catch((response) => {
                        console.error("An error occurred fetching clinicalAnalysis: ", response)
                    });
            }

            clinicalAnalysisObserver() {
                let _samples = [];

                if (UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis) && UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis.family) && UtilsNew.isNotEmptyArray(this.clinicalAnalysis.family.members)) {
                    this.set("family", this.clinicalAnalysis.family);
                    this.clinicalAnalysis.family.members.forEach((member) => {
                        if (UtilsNew.isNotUndefinedOrNull(member.samples)) {
                            member.samples.map((sample) => {
                                _samples.push(sample)
                            });
                        }
                    });
                } else {
                    if (UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis) && UtilsNew.isNotEmptyArray(this.clinicalAnalysis.subjects)) {
                        this.clinicalAnalysis.subjects.forEach((individual) => {
                            individual.samples.map((sample) => {
                                _samples.push(sample)
                            });
                        });
                    } else {
                        console.warn("A Clinical Analysis with no subjects or family has been passed");
                    }
                }
                if (UtilsNew.isNotEmptyArray(_samples)) {
                    // Set samples array and notify, this must be done using Polymer API
                    this.set("samples", _samples);

                    // We need a different private property for variant-browser-filter to avoid circular calls
                    this._initGenotypeSamples(_samples);
                    this.search = Object.assign({}, this.query);

                    // this.set("samplesForMenuFilter", _samples);

                    // Notify to all listeners of the new samples
                    this.dispatchEvent(new CustomEvent('samplechange', {detail: {samples: this.samples}}));
                }
            }

            diseasePanelIdObserver() {
                if (this.diseasePanelId !== undefined && PANELS !== undefined) {
                    for (let panel of PANELS) {
                        if (panel.id === this.diseasePanelId) {
                            this.diseasePanel = panel;
                            // TODO in theory we should do:
                            // this.defaultAutomaticQuery.panel = this.diseasePanelId;
                            this.defaultAutomaticQuery.gene = this.diseasePanel.genes.join(",");
                            break;
                        }
                    }
                }
            }

            interactiveObserver() {
                if (!this.interactive) {
                    this.collapseFilter();
                } else {
                    this.unCollapseFilter();
                }
            }

            onCollapse() {
                if (this._collapsed) {
                    this.unCollapseFilter();
                } else {
                    this.collapseFilter();
                }
            }

            collapseFilter() {
                this.filterClass = "hidden";
                this.gridClass = "prioritization-center";
                this._collapsed = true;
            }

            unCollapseFilter() {
                if (this.interactive) {
                    this.filterClass = "col-md-2";
                    this.gridClass = "col-md-10";
                    this._collapsed = false;
                }
            }

            onClear() {
                this.modeInheritance = "none";
                this.query = {studies: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias};
                this._initGenotypeSamples(this.samples,true);
                this.search = {};
            }

            onFilterChange(e) {
                this.query = Object.assign({},e.detail);
                if (UtilsNew.isUndefinedOrNull(this.query.genotype)) {
                    this.modeInheritance = "none";
                    this._initGenotypeSamples(this.samples, true)
                }
                this.search = e.detail;
            }


            _checkProjects() {
                if (UtilsNew.isNotUndefinedOrNull(this.opencgaSession) && UtilsNew.isNotUndefinedOrNull(this.opencgaSession.projects)) {
                    return this.opencgaSession.projects.length !== 0;
                }
                return false;
            }


            checkVariant(variant) {
                return variant.split(':').length > 2;
            }

            onSelectVariant(e) {
                this.variant = e.detail.id;
                this.variantObj = e.detail.variant;
            }

            onCheckVariant(e) {
                // Alexis: we need to do something like this:
                this.checkedVariants = e.detail.variants;

                // We set/remove disable status to Save button
                if (this.checkedVariants.length > 0 && UtilsNew.isNotEmptyArray(this.samples)) {
                    PolymerUtils.removeAttribute(this.prefix + 'SaveInterpretationButton', 'disabled');
                } else {
                    PolymerUtils.setAttribute(this.prefix + 'SaveInterpretationButton', 'disabled', true);
                }
            }

            onSampleChange(e) {
                let _samples = e.detail.samples;
                this.set('samples', _samples.slice());
                this.dispatchEvent(new CustomEvent("samplechange", {detail: e.detail, bubbles: true, composed: true}));
                this._initGenotypeSamples(this.samples);
            }

            _initGenotypeSamples(samples, force, value) {
                if (UtilsNew.isUndefinedOrNull(this.genotypeSamples)) {
                    this.genotypeSamples = {};
                }
                samples.forEach((sample) => {
                    if (UtilsNew.isUndefinedOrNull(this.genotypeSamples[sample.name]) || force){
                        this.genotypeSamples[sample.name] = {};
                        this.genotypeSamples[sample.name]["0/0"] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                        this.genotypeSamples[sample.name]["1/1"] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                        this.genotypeSamples[sample.name]["0/1"] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                        this.genotypeSamples[sample.name]["./."] = UtilsNew.isNotUndefinedOrNull(value)? value : true;
                    }
                });
                this.query = Object.assign({}, this.query, {genotype: this.getGenotypeFilter(this.genotypeSamples)});
            }

            _changeView(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                PolymerUtils.hide(this.prefix + "TableResult");
                PolymerUtils.hide(this.prefix + "GenomeBrowser");
                // PolymerUtils.hide(this.prefix + "Panels");
                PolymerUtils.hide(this.prefix + "ClinicalData");
                PolymerUtils.hide(this.prefix + "SaveInterpretation");

                if (typeof e.target !== "undefined" && typeof e.target.dataset.view !== "undefined") {
                    PolymerUtils.show(this.prefix + e.target.dataset.view); // get the href and use it find which div to show
                }

                // Show the active button
                PolymerUtils.removeClass(".variant-interpretation-view-buttons", "active");
                $(e.target).addClass("active");

                // Make Genome Browser active
                this._genomeBrowserActive = (e.target.dataset.view === "GenomeBrowser");
            }

            _backToSelectAnalysis(e) {
                this.dispatchEvent(new CustomEvent('backtoselectanalysis', {detail: {idTab: "PrioritizationButton"}}));
            }

            _goToReport(e) {
                this.dispatchEvent(new CustomEvent('gotoreport', {detail: {interpretation: this.interpretation}}));
            }

            triggerBeacon(e) {
                this.variantToBeacon = this.variant;
            }

            onViewInterpretation(e) {
                this.interpretationView = this._createInterpretation();
            }

            onSaveInterpretation(e, obj) {
                let id = PolymerUtils.getValue(this.prefix + "IDInterpretation");
                let name = PolymerUtils.getValue(this.prefix + "NameInterpretation");
                let description = PolymerUtils.getValue(this.prefix + "DescriptionInterpretation");
                let comment = PolymerUtils.getValue(this.prefix + "CommentInterpretation");

                if (UtilsNew.isNotEmpty(id) && UtilsNew.isNotEmpty(name)) {
                    if ((/\s/.test(name)) ||  (/\s/.test(id))) {
                        this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                            detail: {
                                message: "ID or Name must not contains blanks.",
                                type: UtilsNew.MESSAGE_ERROR
                            },
                            bubbles: true,
                            composed: true
                        }));
                    } else {
                        this.interpretation = this._createInterpretation();
                    }
                } else {
                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                        detail: {
                            message: "ID or Name must not be empty.",
                            type: UtilsNew.MESSAGE_ERROR
                        },
                        bubbles: true,
                        composed: true
                    }));
                }
            }

            _createInterpretation() {
                try {
                    let userID = this.opencgaClient._config.userId;
                    let interpretation = {};
                    interpretation.id = this.clinicalAnalysis.id + "_" + PolymerUtils.getValue(this.prefix + "IDInterpretation");
                    interpretation.name = PolymerUtils.getValue(this.prefix + "NameInterpretation");
                    interpretation.description = PolymerUtils.getValue(this.prefix + "DescriptionInterpretation");
                    interpretation.clinicalAnalysis = this.clinicalAnalysis;
                    interpretation.software = {
                        name: "TEAM",
                        version: "2.0",
                        website: "https://www.ncbi.nlm.nih.gov/pubmed/24861626",
                        repository: "https://github.com/opencb/opencga",
                        commit: "f43372aa",
                        params: {}
                    };
                    interpretation.analyst = {
                        name: userID,
                        email: "",
                        company: ""
                    };
                    interpretation.versions = [
                        {
                            id: "cellbase", name: "CellBase", type: "DDBB", version: "4.5.0"
                        }
                    ];
                    interpretation.filters = this.query;
                    //                interpretation.creationDate = Date();
                    interpretation.comments = PolymerUtils.getValue(this.prefix + "CommentInterpretation");
                    interpretation.reportedVariants = this.checkedVariants;
                    interpretation.attributes = {};
                    interpretation.creationDate = moment(new Date(), "YYYYMMDDHHmmss").format('D MMM YY');


                    let params = {
                        study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias
                    };

                    let body = {
                        path: "analysis/" + interpretation.clinicalAnalysis.id + "/" + interpretation.name + "/interpretation.json",
                        content: JSON.stringify(interpretation),
                        parents: true
                    };

                    let _this = this;
                    this.opencgaClient.files().create(params, body)
                        .then((response) => {
                            console.log(response);
                            // TODO We should update here clinicalAnalysis and add to interpretation list this file with its name from save interpertation form.
                            if (UtilsNew.isNotUndefinedOrNull(interpretation) && UtilsNew.isNotUndefinedOrNull(interpretation.clinicalAnalysis)) {
                                if (UtilsNew.isEmptyArray(interpretation.clinicalAnalysis.interpretations)) {
                                    interpretation.clinicalAnalysis.interpretations = [];
                                } else {
                                    interpretation.clinicalAnalysis.interpretations = interpretation.clinicalAnalysis.interpretations.map((interpretation) => {
                                        return { id: interpretation.id, name: interpretation.name, file:  interpretation.file.id };
                                    });
                                }
                                interpretation.clinicalAnalysis.interpretations.push({
                                    id: interpretation.id,
                                    name: interpretation.id,
                                    file: response.response[0].result[0].id
                                });
                            }

                            params = {
                                study: _this.opencgaSession.project.alias + ":" + _this.opencgaSession.study.alias
                            };
                            let interpretations =  { interpretations: interpretation.clinicalAnalysis.interpretations };
                            _this.opencgaClient.clinical().update(interpretation.clinicalAnalysis.id, params, interpretations)
                                .then((response) => {
                                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                                        detail: {
                                            message:  interpretation.id + " interpretation has been created correctly.",
                                            type: UtilsNew.MESSAGE_SUCCESS
                                        },
                                        bubbles: true,
                                        composed: true
                                    }));

                                    _this.cleanSaveInterpretation();
                                    console.log(response);
                                    // Update analysis with new interpretations
                                    _this.getAnalysisInterpretations();
                                })
                                .catch((err) => {
                                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                                        detail: {
                                            message:  err.error,
                                            type: UtilsNew.MESSAGE_ERROR
                                        },
                                        bubbles: true,
                                        composed: true
                                    }));
                                });
                        })
                        .catch((err) => {
                            this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                                detail: {
                                    message:  err.error,
                                    type: UtilsNew.MESSAGE_ERROR
                                },
                                bubbles: true,
                                composed: true
                            }));
                        });

                } catch (err) {
                    this.dispatchEvent(new CustomEvent(this.eventNotifyName, {
                        detail: {
                            message:  err,
                            type: UtilsNew.MESSAGE_ERROR
                        },
                        bubbles: true,
                        composed: true
                    }));
                }
            }

            cleanSaveInterpretation() {
                PolymerUtils.setValue(this.prefix + "IDInterpretation", "");
                PolymerUtils.setValue(this.prefix + "NameInterpretation", "");
                PolymerUtils.setValue(this.prefix + "DescriptionInterpretation", "");
                PolymerUtils.setValue(this.prefix + "CommentInterpretation", "");
            }

            getAnalysisInterpretations() {
                let params = {
                    study: this.opencgaSession.project.alias + ":" + this.opencgaSession.study.alias
                };
                let _this = this;
                this.opencgaClient.clinical().info(this.clinicalAnalysis.id, params, {})
                    .then(function(response){
                        _this.showSummary = false;
                        if (response.response[0].numResults === 1) {
                            _this.clinicalAnalysis = response.response[0].result[0];
                        }
                    });
            }

            _getFileMetricsArray() {
                if (this.variantObj === undefined || this.variantObj.studies === undefined) {
                    return [];
                }
                let files = this.variantObj.studies[0].files;
                // Let's find all the existing attributes
                let attributesSet = new Set();
                for (let file of files) {
                    for(let attr of Object.keys(file.attributes)) {
                        if (attr !== "QUAL" && attr !== "FILTER") {
                            attributesSet.add(attr);
                        }
                    }
                }
                let attributesArray = Array.from(attributesSet.values()).sort();
                attributesArray.unshift("QUAL", "FILTER");

                // We store the values as: result = [{name: "AC", values: [1, 2, 3, 4]}]
                let result = [];
                for (let attr of attributesArray) {
                    let tmp = {name: attr, values: []};
                    for (let file of files) {
                        tmp.values.push(file.attributes[attr]);
                    }
                    result.push(tmp);
                }
                return result;
            }

            getGenotypeFilter(genotypeSamples) {
                let genotype = "";
                debugger;
                this.samples.forEach((sample) => {
                    if (UtilsNew.isNotUndefinedOrNull(genotypeSamples[sample.name])) {
                        genotype += sample.name+ ":"
                        let gt = [];
                        if (genotypeSamples[sample.name]["0/0"]) {
                            gt.push("0/0");
                        }
                        if (genotypeSamples[sample.name]["0/1"]) {
                            gt.push("0/1");
                        }
                        if (genotypeSamples[sample.name]["1/1"]) {
                            gt.push("1/1");
                        }
                        if (genotypeSamples[sample.name]["./."]) {
                            gt.push("./.");
                        }
                        genotype += gt.join(",") + ";"
                    }
                });


                return genotype;
            }

            /*
            * Inheritance Mode Methods
            * @TODO We should remove this when exists in server an endpoint to get this values
            */
            _onInheritanceMode(e) {
                // Recover modeInheritance selected and decisionTree from settings tools
                this.decisionTreeInheritanceMode = e.detail.decisionTreeInheritance;

                // Init for each sample its value for each genotype
                if (this.modeInheritance !== "autoDominant" && this.modeInheritance !== "autoRecessive" && this.modeInheritance !== "xLinked" && this.modeInheritance !== "yLinked") {
                    this._initGenotypeSamples(this.samples, true);
                    this.genotypeSamples = Object.assign({}, this.genotypeSamples);
                    return;
                }

                this._initGenotypeSamples(this.samples, true, false);
                // Get genotype values
                this.genotypeSamples = Segregations.inheritanceMode(this.modeInheritance, this.clinicalAnalysis, this.genotypeSamples, this.samples);
                this.query = Object.assign({}, this.query, {genotype: this.getGenotypeFilter(this.genotypeSamples)});
            }
        }

        customElements.define(OpencgaVariantInterpretation.is, OpencgaVariantInterpretation);
    </script>
</dom-module>
