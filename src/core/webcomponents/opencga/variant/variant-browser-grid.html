<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="variant-browser-grid">
    <template>
        <style include="jso-styles"></style>

        <div id="{{prefix}}ToolbarLeft" style="float: left;margin: 20px 0px 0px 0px">
            <span style="font-size: 14px">Showing <label>{{from}}-{{to}}</label> of <label>{{numTotalResultsText}}</label> variants</span>
        </div>
        <div id="{{prefix}}toolbar" style="float:right;margin: 10px 0px 10px 0px">
            <div class="btn-group">
                <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i id="{{prefix}}DownloadRefresh" class="fa fa-refresh fa-spin" aria-hidden="true" style="font-size:14px;display: none"></i>
                    <i id="{{prefix}}DownloadIcon" class="fa fa-download" aria-hidden="true"></i> Download <span class="caret"></span>
                </button>
                <ul class="dropdown-menu btn-sm">
                    <li><a id="{{prefix}}DownloadTabLink" on-click="_downloadTabFile">Tab</a></li>
                    <li><a id="{{prefix}}DownloadJsonLink" on-click="_downloadJsonFile">JSON</a></li>
                </ul>
            </div>

            <!--Share URL-->
            <button type="button" class="btn btn-default btn-sm" data-toggle="popover" data-placement="bottom" on-click="_shareLink">
                <i class="fa fa-share-alt" aria-hidden="true"></i> Share
            </button>

            <!--Save -->
            <template is="dom-if" if="{{showSelect}}">
                <button type="button" class="btn btn-default btn-sm" data-toggle="popover" data-placement="bottom" on-click="_saveLink">
                    <i class="fa fa-floppy-o" aria-hidden="true"></i> Save
                </button>
            </template>

            <!--<button type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample" on-click="_test">-->
            <!--<i class="fa fa-share-alt" aria-hidden="true"></i> Share-->
            <!--</button>-->
            <!--<div class="collapse" id="collapseExample" style="padding-top: 5px">-->
            <!--<div class="well" style="background-color: #FAFAFA">-->
            <!--URL:<br>-->
            <!--{{_test()}}-->
            <!--</div>-->
            <!--</div>-->
        </div>

        <div id="{{prefix}}GridTableDiv" style="margin-top: 10px">
            <table id="{{prefix}}VariantBrowserGrid" data-pagination="true" data-page-list="[10, 25, 50]" data-show-export="true" data-id-field="variant">
                <thead style="background-color: #eee"></thead>
            </table>
        </div>
    </template>

    <script>
        class VariantBrowserGrid extends Polymer.Element {

            static get is() {
                return 'variant-browser-grid';
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object,
                        observer: 'renderFromServer'
                    },
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object,
                        observer: 'renderFromServer'
                    },
                    mode: {
                        type: String
                    },
                    data: {
                        type: Array,
                        value: [],
                        observer: 'renderFromLocal'
                    },
                    samples: {
                        type: Array,
                        value: [],
                        observer: '_refreshTableColumns'
                    },
                    cohorts: {
                        type: Object,
                        observer: '_refreshTableColumns'
                    },
                    consequenceTypes: {
                        type: Object,
                        observer: 'assignColors'
                    },
                    populationFrequencies: {
                        type: Object,
                        value: {},
                        observer: '_refreshTableColumns'
                    },
                    proteinSubstitutionScores: {
                        type: Object,
                        observer: 'assignColors'
                    },
                    query: {
                        type: Object
//                        observer: 'renderFromServer'
                    },
                    search: {
                        type: Object,
                        observer: 'renderFromServer'
                    },
                    showPopFreqInColor: {
                        type: Boolean,
                        value: true
                    },
                    queryCellbase: {
                        type: Boolean,
                        value: false
                    },
                    summary: {
                        type: Boolean
                    },
                    config: {
                        type: Object
                    },
                    variant: {
                        type: String,
                        notify: true
                    },
                    showSelect: {
                        type: Boolean,
                        value: false
                    },
                    prefix: {
                        type: String
                    }
                }
            }

            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            _test() {
                let getUrlQueryParams = this._getUrlQueryParams();
                return ">>" + getUrlQueryParams.url;
            }

            ready() {
                super.ready();

                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "table" + Utils.randomString(6);
                }
                this.analysisMode = "family";

            }

            connectedCallback() {
                super.connectedCallback();

                // TODO Refactor
                this.table = $('#' + this.prefix + 'VariantBrowserGrid');
                this.downloadRefreshIcon = $("#" + this.prefix + "DownloadRefresh");
                this.downloadIcon = $("#" + this.prefix + "DownloadIcon");
                this._refreshTableColumns();
            }

            assignColors() {
                if (typeof this.consequenceTypes !== "undefined") {
                    let consequenceTypeToColor = {};
                    let consequenceTypeToImpact = {};
                    for (let i = 0; i < this.consequenceTypes.categories.length; i++) {
                        if (typeof this.consequenceTypes.categories[i].terms !== "undefined") {
                            for (let j = 0; j < this.consequenceTypes.categories[i].terms.length; j++) {
                                consequenceTypeToColor[this.consequenceTypes.categories[i].terms[j].name] = this.consequenceTypes.color[this.consequenceTypes.categories[i].terms[j].impact];
                                consequenceTypeToImpact[this.consequenceTypes.categories[i].terms[j].name] = this.consequenceTypes.categories[i].terms[j].impact;
                            }
                        } else if (typeof this.consequenceTypes.categories[i].id !== "undefined" && typeof this.consequenceTypes.categories[i].name !== "undefined") {
                            consequenceTypeToColor[this.consequenceTypes.categories[i].name] = this.consequenceTypes.color[this.consequenceTypes.categories[i].impact];
                            consequenceTypeToImpact[this.consequenceTypes.categories[i].name] = this.consequenceTypes.categories[i].impact;
                        }
                    }
                    this.consequenceTypeToColor = consequenceTypeToColor;
                    this.consequenceTypeToImpact = consequenceTypeToImpact;
                }

                if (typeof this.proteinSubstitutionScores !== "undefined") {
                    let pssColor = new Map();
                    for (let i in this.proteinSubstitutionScores) {
                        let obj = this.proteinSubstitutionScores[i];
                        Object.keys(obj).forEach(key => {
                            pssColor.set(key, obj[key]);
                        });
                    }
                    this.pssColor = pssColor;
                }
                this.renderFromServer();
            }
            renderFromServer() {

                this.variant = ""; // Empty the variant every time the grid is loaded

                this.from = 1;
                this.to = 10;

                let _table = $('#' + this.prefix + 'VariantBrowserGrid');
                let _this = this;
                if (typeof this.opencgaClient !== "undefined" && this.opencgaClient instanceof OpenCGAClient && typeof
                        this.project !== "undefined" && typeof this.study !== "undefined" && typeof this.study.alias !== "undefined") {

                    let urlQueryParams = this._getUrlQueryParams();
                    let queryParams = urlQueryParams.queryParams;
                    let _numTotal = -1;
                    $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('destroy');
                    $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable({
                        url: urlQueryParams.host,
                        columns: _this.cols,
                        method: 'get',
                        sidePagination: 'server',
                        queryParams: function (params) {
                            queryParams.limit = params.limit;
                            queryParams.skip = params.offset;
//                            queryParams.skipCount = true;
                            if (typeof _this.query !== 'undefined' && typeof _this.query.gene !== 'undefined' && _this.query.gene != "") {
                                queryParams.skipCount = false;
                            }
                            return queryParams;
                        },
                        responseHandler: function (res) {
                            if (_numTotal == -1) {
                                if (_this.summary
                                    || (typeof _this.query !== 'undefined' && typeof _this.query.gene !== 'undefined' && _this.query.gene != "")) {
                                    _numTotal = res.response[0].numTotalResults;
//                                    _numTotal = 1150;
                                } else {
                                    _numTotal = 1150;
                                }
                            }
                            _this.numTotalResultsText = _numTotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            return {total: _numTotal, rows: res.response[0].result}
                        },
                        onClickRow: function (row, $element) {
                            $('.success').removeClass('success');
                            $($element).addClass('success');

                            _this._onSelectVariant(row);
                        },
                        onCheck: function (row, $element) {
//                            $('.success').removeClass('success');
//                            $($element).addClass('success');

                            let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                            _this.dispatchEvent(new CustomEvent('checkvariant', {
                                detail: {
                                    id: _variant,
                                    variant: row,
                                    variants: $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('getAllSelections')
                                }
                            }));
                        },
                        onLoadSuccess: function (data) {
                            // The first time we mark as selected the first row that is rows[2] since the first two rows are the header
                            if (UtilsNew.isNotUndefinedOrNull(_table)) {
                                PolymerUtils.querySelector(_table.selector).rows[2].setAttribute('class', 'success');
                                _this._onSelectVariant(data.rows[0]);

                            }
                        },
                        onPageChange: function (page, size) {
                            _this.from = (page - 1) * size + 1;
                            _this.to = page * size;
                        }
                    });
                    if (!this.showSelect) {
                        $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('hideColumn', "stateCheckBox");
                    }
                    $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('showLoading');
                }

                // To query from cellbase, 'queryCellbase' property must be set to true explicitly
                if (typeof this.queryCellbase !== "undefined" && this.queryCellbase && this.cellbaseClient instanceof CellBaseClient) {
                    $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('destroy');
                    let _numTotal = -1;

                    let url = "";
                    if (this.cellbaseClient._config.hosts[0].startsWith("https://")) {
                        url = this.cellbaseClient._config.hosts[0];
                    } else {
                        url = 'http://' + this.cellbaseClient._config.hosts[0];
                    }

                    let queryParams = {
                        timeout: 20000
                    };

                    Object.assign(queryParams, _this.query); // Important : Adding the query object contents to queryParams

                    url = url + '/webservices/rest/v4/' + this.cellbaseClient._config.species + '/feature/variation/search';
                    $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable({
                        url: url,
                        method: 'get',
                        sidePagination: 'server',
                        queryParams: function (params) {
                            queryParams.limit = params.limit;
                            queryParams.skip = params.offset;
//                            queryParams.summary = true;
                            return queryParams;
                        },
                        responseHandler: function (res) {
                            if (_numTotal == -1) {
                                _numTotal = res.response[0].numTotalResults;
                                _this.count = _numTotal;
                            }
                            return {total: _numTotal, rows: res.response[0].result}
                        },
                        columns: _this.cols,
                        onClickRow: function (row, $element) {
                            _this.variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                            $('.success').removeClass('success');
                            $($element).addClass('success');
                        }
                    });
                    $('#' + _this.prefix + 'VariantBrowserGrid').bootstrapTable('showLoading');
                }

            }

            _getUrlQueryParams() {
                if (typeof this.opencgaClient === "undefined") {
                    return {host: "", queryParams: {}, url: ""};
                }

                let host = "";
                if (this.opencgaClient.getConfig().host.startsWith("https://")) {
                    host = this.opencgaClient.getConfig().host;
                } else {
                    host = 'http://' + this.opencgaClient.getConfig().host;
                }

                if (typeof this.project !== "undefined" && typeof this.study.alias !== "undefined") {
                    if (typeof this.query === "undefined") {
                        this.query = {};
                    }
                    if (typeof this.query.studies === "undefined" || this.query.studies === "" || this.query.studies.split(new RegExp("[,;]")).length === 1) {
                        this.query.studies = this.project.alias + ":" + this.study.alias;
                    }
                    host += '/webservices/rest/v1/analysis/variant/query';
                } else {
                    return {host: host, queryParams: {}, url: ""};
                }

                let queryParams = {
                    sid: this.opencgaClient._config.sessionId,
                    timeout: 60000,
                    summary: this.summary
                };

                Object.assign(queryParams, this.query); // Important : Adding the query object contents to queryParams

                if (typeof this.samples !== "undefined" && this.samples.length > 0) {
                    let sampleNames = [];
                    let sampleIdx = {};
                    for (sampleIdx in this.samples) {
                        sampleNames.push(this.samples[sampleIdx].name);
                    }
                    queryParams.returnedSamples = sampleNames.join();
                } else {
                    queryParams.exclude = "studies";
                }

                if (typeof this.config !== "undefined" && typeof this.config.missing !== "undefined" && this.config.missing) {
                    let keys = Object.keys(queryParams);
                    for (let i = 0; i < keys.length; i++) {
                        let val = queryParams[keys[i]];
                        if (typeof val == "string") {
                            val = val.replace(/</g, "<<");
                            val = val.replace(/>/g, ">>");
                            queryParams[keys[i]] = val;
                        }
                    }
                }

                let query = ["limit=1000"];
                for (let key in queryParams) {
                    // Check sid has a proper value. For public projects sid is undefined. In that case, sid must be removed from the url
                    if (key == "sid" && queryParams[key] === undefined) {
                        delete queryParams["sid"];
                    } else {
                        query.push(key + "=" + queryParams[key]);
                    }
                }
                let url = host + "?" + query.join("&");

                return {host: host, queryParams: queryParams, url: url};
            }
            _onSelectVariant(row) {
                if (typeof row !== "undefined") {
//                    debugger
                    let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
//                    this.fire('selectvariant', {id: _variant, variant: row});
                    this.dispatchEvent(new CustomEvent('selectvariant', {detail: {id: _variant, variant: row}}));
                }
            }
            renderFromLocal() {
                let _this = this;
                $('#' + this.prefix + 'VariantBrowserGrid').bootstrapTable('destroy');
                $('#' + this.prefix + 'VariantBrowserGrid').bootstrapTable({
                    data: this.data,
                    columns: this.cols,
                    onClickRow: function (row, $element) {
                        _this.variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                        $('.success').removeClass('success');
                        $($element).addClass('success');
                    }
                });
            }
            showGene(geneName) {
//                this.fire('selected', {gene: geneName});
                this.dispatchEvent(new CustomEvent('selected', {detail: {gene: geneName}}));
            }
            variantFormatter(value, row, index) {
                let ref = (row.reference != "") ? row.reference : "-";
                let alt = (row.alternate != "") ? row.alternate : "-";
                return "<span style='white-space: nowrap'>" + row.chromosome + ':' + row.start + " " + ref + '/' + alt + "</span>";
            }
            snpFormatter(value, row, index) {
                if (typeof row.id !== "undefined" && row.id.startsWith("rs")) {
                    return "<a target='_blank' href='http://grch37.ensembl.org/Homo_sapiens/Variation/Explore?vdb=variation;v=" + row.id + "'>" + row.id + "</a>";
                } else {
                    return '-';
                }
            }
            geneFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined") {
                    if (typeof row.annotation !== "undefined" && typeof row.annotation.consequenceTypes !== "undefined" && row.annotation.consequenceTypes.length > 0) {
                        var visited = {};
                        var geneLinks = [];
                        for (let i = 0; i < row.annotation.consequenceTypes.length; i++) {
                            if (typeof row.annotation.consequenceTypes[i].geneName !== "undefined" && row.annotation.consequenceTypes[i].geneName != ""
                                && typeof visited[row.annotation.consequenceTypes[i].geneName] === "undefined") {
                                if (typeof this.field.context.project !== "undefined" && typeof this.field.context.study !== "undefined") {
                                    geneLinks.push('<a style="cursor: pointer;white-space: nowrap" href="#gene/' + this.field.context.project.alias +'/' +
                                        this.field.context.study.alias + '/' + row.annotation.consequenceTypes[i].geneName + '">' + row.annotation.consequenceTypes[i].geneName + '</a>');
                                } else {
                                    geneLinks.push('<a style="cursor: pointer;white-space: nowrap">' + row.annotation.consequenceTypes[i].geneName + '</a>')
                                }
                                visited[row.annotation.consequenceTypes[i].geneName] = true;
                            }
                        }
                        return geneLinks.join(',');
                    }
                }
                return '-';
            }
            consequenceTypeFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined") {
                    if (typeof row.annotation !== "undefined" && typeof row.annotation.consequenceTypes !== "undefined" && row.annotation.consequenceTypes.length > 0) {
                        var consequenceTypesArr = [];
                        var visited = new Set();
                        var impact = {};
                        for (let i = 0; i < row.annotation.consequenceTypes.length; i++) {
                            for (let j = 0; j < row.annotation.consequenceTypes[i].sequenceOntologyTerms.length; j++) {

                                let consequenceTypeName = row.annotation.consequenceTypes[i].sequenceOntologyTerms[j].name;

                                // FIXME This is a temporal fix for some wrong CTs. This must be removed ASAP.
                                if (consequenceTypeName == "2KB_downstream_gene_variant") {
                                    consequenceTypeName = "2KB_downstream_variant";
                                }
                                if (consequenceTypeName == "2KB_upstream_gene_variant") {
                                    consequenceTypeName = "2KB_upstream_variant";
                                }

                                if (typeof consequenceTypeName !== "undefined" && consequenceTypeName != "" && !visited.has(consequenceTypeName)) {
                                    if (typeof this.field.context.consequenceTypeToImpact !== "undefined" && typeof this.field.context.consequenceTypeToImpact[consequenceTypeName] !== "undefined") {
                                        let imp = this.field.context.consequenceTypeToImpact[consequenceTypeName];
                                        if (typeof impact[imp] === "undefined") {
                                            impact[imp] = [];
                                        }
                                        if (typeof this.field.context.consequenceTypeToColor !== "undefined" && typeof this.field.context.consequenceTypeToColor[consequenceTypeName] !== "undefined") {
                                            impact[imp].push('<span style="color: ' + this.field.context.consequenceTypeToColor[consequenceTypeName] + '">' + consequenceTypeName + '</span>');
                                        } else {
                                            impact[imp].push('<span>' + consequenceTypeName + '</span>');
                                        }

                                    }
                                    visited.add(consequenceTypeName);
                                }
                            }
                        }

                        if (Object.keys(impact).length > 0) {
                            if (typeof impact["high"] !== "undefined" || typeof impact["moderate"] !== "undefined") {
                                if (typeof impact["high"] !== "undefined") {
                                    Array.prototype.push.apply(consequenceTypesArr, impact["high"]);
                                }
                                if (typeof impact["moderate"] !== "undefined") {
                                    Array.prototype.push.apply(consequenceTypesArr, impact["moderate"]);
                                }
                            } else if (typeof impact["low"] !== "undefined") {
                                Array.prototype.push.apply(consequenceTypesArr, impact["low"]);
                            } else if (typeof impact["modifier"] !== "undefined") {
                                Array.prototype.push.apply(consequenceTypesArr, impact["modifier"]);
                            }
                        }

                        return consequenceTypesArr.join('<br>');
                    }
                }
                return '-';
            }
            proteinScoreFormatter(value, row, index) {
                var min = 10;
                var max = 0;
                let description = {};
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined") {
                    if (typeof row.annotation !== "undefined" && typeof row.annotation.consequenceTypes !== "undefined") {
                        for (let i = 0; i < row.annotation.consequenceTypes.length; i++) {
                            if (typeof row.annotation.consequenceTypes[i].proteinVariantAnnotation !== "undefined"
                                && typeof row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores !== "undefined") {
                                for (let j = 0; j < row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores.length; j++) {
                                    if (row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores[j].source == this.field.source) {
                                        switch (this.field.source) {
                                            case "sift":
                                                if (row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores[j].score < min) {
                                                    min = row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores[j].score;
                                                    description.sift = row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores[j].description;
                                                }
                                                break;
                                            case "polyphen":
                                                if (row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores[j].score > max) {
                                                    max = row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores[j].score;
                                                    description.polyphen = row.annotation.consequenceTypes[i].proteinVariantAnnotation.substitutionScores[j].description;
                                                }
                                                break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (this.field.source == 'sift' && min != 10) {
                    return '<span style="color: ' + this.field.context.pssColor.get(description.sift) + '" title="' + min + '">' + description.sift + '</span>';
                } else if (this.field.source == 'polyphen' && max != 0) {
                    let str = description.polyphen;
                    if (str.indexOf(' ') >= 0) {
                        str = str
                            .replace(/\s(.)/g, function($1) { return $1.toUpperCase(); })
                            .replace(/\s/g, '')
                            .replace(/^(.)/, function($1) { return $1.toLowerCase(); });
                    }
                    return '<span style="color: ' + this.field.context.pssColor.get(str) + '" title="' + max + '">' + description.polyphen + '</span>';
                }
                return '-';
            }
            caddScaledFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined" && typeof row.annotation.functionalScore !== "undefined") {
                    for (let i = 0; i < row.annotation.functionalScore.length; i++) {
                        if (typeof row.annotation.functionalScore[i] !== "undefined" && row.annotation.functionalScore[i].source == "cadd_scaled" && row.type != "INDEL") {
                            let value = Number(row.annotation.functionalScore[i].score).toFixed(2);
                            if (value < 15) {
                                return value;
                            } else {
                                return '<span style="color: red">' + value + '</span>';
                            }
                        }
                    }
                }
                return '-';
            }
            conservationFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined" && typeof row.annotation.conservation !== "undefined") {
                    for (let i = 0; i < row.annotation.conservation.length; i++) {
                        if (row.annotation.conservation[i].source == this.field) {
                            return Number(row.annotation.conservation[i].score).toFixed(3);
                        }
                    }
                }
                return '-';
            }
            cohortFormatter(value, row, index) {
                if (typeof this.field.cohorts !== "undefined" && this.field.cohorts.length > 0) {

                    let data = new Map();
                    for (let i in row.studies) {
                        // to be removed!!
                        if (this.field.study == "BRIDGE") {
                            this.field.study = "bridge";
                        }
                        if (row.studies[i].studyId == this.field.study) {
                            let cohortNames = Object.keys(row.studies[i].stats);
                            for (let j in cohortNames) {
                                data.set(cohortNames[j], Number(row.studies[i].stats[cohortNames[j]].maf).toFixed(4));
                            }
                            break;
                        }
                    }

                    let tableSize = this.field.cohorts.length * 15;
                    let htmlCohortsTable = "<table style='width: " + tableSize + "px'><tr>";
                    for (let i = 0; i < this.field.cohorts.length; i++) {
                        let popFreq = this.field.cohorts[i].id;
                        if (typeof data.get(popFreq) !== "undefined") {
                            let freq = data.get(this.field.cohorts[i].id);
                            if (freq < 0.001) {
                                htmlCohortsTable += "<td style='width: 15px; background: " + this.field.colors.veryRare + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            } else if (freq < 0.005) {
                                htmlCohortsTable += "<td style='width: 15px; background: " + this.field.colors.rare + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            } else if (freq < 0.05) {
                                htmlCohortsTable += "<td style='width: 15px; background: " + this.field.colors.average + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            } else {
                                htmlCohortsTable += "<td style='width: 15px; background: " + this.field.colors.common + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            }
                        } else  {
                            htmlCohortsTable += "<td style='width: 15px; background: black;' title='" + popFreq + ": NA'>&nbsp;</td>";
                        }
                    }
                    htmlCohortsTable += "</tr></table>";

                    return htmlCohortsTable;
                }
                return '-';
            }
            populationFrequenciesFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined" && typeof row.annotation.populationFrequencies !== "undefined") {
                    for (let popFreqIdx in row.annotation.populationFrequencies) {
                        let popFreq = row.annotation.populationFrequencies[popFreqIdx];
                        let studyPopulation = popFreq.study + ":" + popFreq.population;
                        if (studyPopulation == this.field.population) {
                            if (Number(popFreq.altAlleleFreq).toFixed(4) < 0.001) {
                                return '<span style="color: ' + this.field.colors.veryRare + '">' + Number(popFreq.altAlleleFreq).toFixed(4) + '</span>';
                            } else if (Number(popFreq.altAlleleFreq).toFixed(4) < 0.005) {
                                return '<span style="color: ' + this.field.colors.rare + '">' + Number(popFreq.altAlleleFreq).toFixed(4) + '</span>';
                            } else if (Number(popFreq.altAlleleFreq).toFixed(4) < 0.05) {
                                return '<span style="color: ' + this.field.colors.average + '">' + Number(popFreq.altAlleleFreq).toFixed(4) + '</span>';
                            } else {
                                return '<span style="color: ' + this.field.colors.common + '">' + Number(popFreq.altAlleleFreq).toFixed(4) + '</span>';
                            }
                        }
                    }
                }
                return '-';
            }
            populationFrequenciesFormatter2(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined" && typeof row.annotation.populationFrequencies !== "undefined") {

                    let data = new Map();
                    for (let popFreqIdx in row.annotation.populationFrequencies) {
                        let popFreq = row.annotation.populationFrequencies[popFreqIdx];
                        if (this.field.study === popFreq.study && this.field.populationMap[popFreq.population] === true) {
                            data.set(popFreq.population, Number(popFreq.altAlleleFreq).toFixed(4));
                        }
                    }

                    let tableSize = this.field.populations.length * 15;
                    // Creates the colored table with one row and as many columns as populations
                    let htmlPopFreqTable = "<table style='width: " + tableSize + "px'><tr>";
                    for (let p in this.field.populations) {
                        let popFreq = this.field.populations[p];
                        if (typeof data.get(popFreq) !== "undefined") {
                            let freq = data.get(this.field.populations[p]);
                            if (freq < 0.001) {
                                htmlPopFreqTable += "<td style='width: 15px; background: " + this.field.colors.veryRare + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            } else if (freq < 0.005) {
                                htmlPopFreqTable += "<td style='width: 15px; background: " + this.field.colors.rare + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            } else if (freq < 0.05) {
                                htmlPopFreqTable += "<td style='width: 15px; background: " + this.field.colors.average + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            } else {
                                htmlPopFreqTable += "<td style='width: 15px; background: " + this.field.colors.common + "' title='" + popFreq + ": " + freq + "'>&nbsp;</td>";
                            }
                        } else  {
                            htmlPopFreqTable += "<td style='width: 15px; background: black;' title='" + popFreq + ": NA'>&nbsp;</td>";
                        }
                    }
                    htmlPopFreqTable += "</tr></table>";

                    return htmlPopFreqTable;
                }
                return '-';
            }
            clinvarFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined" && typeof row.annotation.variantTraitAssociation !== "undefined") {
                    if (row.annotation.variantTraitAssociation != null) {
                        let traits = [];
                        let clinicalData = row.annotation.variantTraitAssociation[this.field];
                        if (typeof clinicalData !== "undefined") {
                            for (let j = 0; j < clinicalData.length; j++) {
                                if (this.field == "clinvar" || this.field == "gwas" && traits.indexOf(clinicalData[j].traits[0]) == -1) {
                                    traits.push(clinicalData[j].traits[0]);
                                } else if (this.field == "cosmic" && traits.indexOf(clinicalData[j].primaryHistology) == -1) {
                                    traits.push(clinicalData[j].primaryHistology);
                                }
                            }
                        }
                        if (traits.length > 0) {
                            return traits.join('<br>');
                        }
                    }
                }
                return '-';
            }
            sampleFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.studies !== "undefined" && row.studies.length > 0) {
                    // NOTE: There are always 4 columns before the samples
                    for (let studyIdx in row.studies) {
                        if (row.studies[studyIdx].samplesData.length > 0) {
                            if (typeof row.studies[studyIdx].samplesData[this.fieldIndex - 5] !== "undefined") {
                                return row.studies[studyIdx].samplesData[this.fieldIndex - 5][0];
                            }
                        }
                    }
                }
                return '-';
            }
            _refreshTableColumns() {
                this.cols = this._createDefaultColumns();

                if (typeof this.cols !== "undefined" && typeof this.cohorts !== "undefined" && Object.keys(this.cohorts).length > 0) {
                    let cohortIdx = 6;
                    let cohortStudies = Object.keys(this.cohorts);
                    this.cols[0].splice(8, 0, {
                        title: this.project.name,
                        field: 'cohorts',
                        rowspan: 1,
                        colspan: cohortStudies.length,
                        halign: 'center'
                    });

                    for(let i = 0; i < cohortStudies.length; i++) {
                        this.cols[1].splice(i + cohortIdx, 0, {
                            title: cohortStudies[i],
                            field: {
                                study: cohortStudies[i],
                                cohorts: this.cohorts[cohortStudies[i]],
                                colors: this.populationFrequencies.color
                            },
                            rowspan: 1,
                            colspan: 1,
                            formatter: this.cohortFormatter,
                            halign: 'center'
                        });
                    }
                }

                if (typeof this.populationFrequencies !== "undefined" && typeof this.populationFrequencies.studies !== "undefined" && this.populationFrequencies.studies.length > 0) {
                    if (this.showPopFreqInColor) {
                        let popIdx = 8;
                        let subPopIdx = 6;
                        if (typeof this.cohorts !== "undefined" && Object.keys(this.cohorts).length > 0) {
                            popIdx++;
                            subPopIdx += Object.keys(this.cohorts).length;
                        }

                        // Just one column called 'Population Frequencies'
                        this.cols[0].splice(popIdx, 0, {
                            title: 'Population Frequencies <a data-toggle="tooltip" title="One coloured square is shown for each cohort, e.g. population. ' +
                            'Frequencies are visualized as colours which classify values into very rare, rare, average, common or missing, see http://www.dialogues-cns.com/wp-content/uploads/2015/03/DialoguesClinNeurosci-17-69-g001.jpg. Please, leave ' +
                            'the cursor over each square to visualize the actual frequency value."><i class="fa fa-info-circle" aria-hidden="true"></i></a>' +
                            '<div style="width: 60%;margin: auto"><div style="float: left">Legend:&nbsp;&nbsp;</div>' +
                            '<div style="float: left; width: 10px;height: 10px;margin: 6px 2px; border: 1px solid rgba(0, 0, 0, .2); background:' + this.populationFrequencies.color.veryRare + '" title="Very rare:  freq < 0.001"></div>' +
                            '<div style="float: left; width: 10px;height: 10px;margin: 6px 2px; border: 1px solid rgba(0, 0, 0, .2); background:' + this.populationFrequencies.color.rare + '" title="Rare:  freq < 0.005"></div>' +
                            '<div style="float: left; width: 10px;height: 10px;margin: 6px 2px; border: 1px solid rgba(0, 0, 0, .2); background:' + this.populationFrequencies.color.average + '" title="Average:  freq < 0.05"></div>' +
                            '<div style="float: left; width: 10px;height: 10px;margin: 6px 2px; border: 1px solid rgba(0, 0, 0, .2); background:' + this.populationFrequencies.color.common + '" title="Common:  freq >= 0.05"></div>' +
                            '</div>',
                            field: '',
                            rowspan: 1,
                            colspan: this.populationFrequencies.studies.length,
                            halign: 'center'
                        });

                        for (let j = 0; j < this.populationFrequencies.studies.length; j++) {
                            let populations = [];
                            let populationMap = {};
                            for (let pop in this.populationFrequencies.studies[j].populations) {
                                populations.push(this.populationFrequencies.studies[j].populations[pop].id);
                                populationMap[this.populationFrequencies.studies[j].populations[pop].id] = true;
                            }

                            this.cols[1].splice(j + subPopIdx, 0, {
                                title: this.populationFrequencies.studies[j].title,
                                field: {
                                    study: this.populationFrequencies.studies[j].id,
                                    populations: populations,
                                    populationMap: populationMap,
                                    colors: this.populationFrequencies.color
                                },
                                rowspan: 1,
                                colspan: 1,
                                formatter: this.populationFrequenciesFormatter2,
                                halign: 'center'
                            });
                        }
                    } else {
                        let popIdx = 7;
                        for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                            let study = this.populationFrequencies.studies[i];
                            this.cols[0].splice(8 + i, 0, {
                                title: study.title,
                                field: study.id,
                                rowspan: 1,
                                colspan: study.populations.length,
                                halign: 'center'
                            });
                            if (i > 0) {
                                popIdx += this.populationFrequencies.studies[i - 1].populations.length;
                            }
                            for (let j = 0; j < study.populations.length; j++) {
                                this.cols[1].splice(j + popIdx, 0, {
                                    title: study.populations[j].id,
                                    field: {
                                        population: study.id + ":" + study.populations[j].id,
                                        colors: this.populationFrequencies.color
                                    },
                                    rowspan: 1,
                                    colspan: 1,
                                    formatter: this.populationFrequenciesFormatter,
                                    halign: 'center',
                                    align: 'right'
                                });
                            }
                        }
                    }
                }

                if (typeof this.cols !== "undefined" && typeof this.samples !== "undefined" && this.samples.length > 0) {
                    switch(this.analysisMode) {
                        case "family":
                            // if type is 'family' we expected few samples to be provided in property 'samples'
                            this.cols[0].splice(5, 0, {
                                title: 'Samples',
                                field: 'samples',
                                rowspan: 1,
                                colspan: this.samples.length,
                                halign: 'center'
                            });
                            for(let i = 0; i < this.samples.length; i++) {
                                this.cols[1].splice(i, 0, {
                                    title: this.samples[i].name,
                                    field: 'samples',
                                    rowspan: 1,
                                    colspan: 1,
                                    formatter: this.sampleFormatter,
                                    halign: 'center'
                                });
                            }
                            break;
                        case "cancer":
                            this.cols[0].splice(5, 0, {
                                title: this.samples[0].name,
                                field: 'samples',
                                rowspan: 1,
                                colspan: 2,
                                halign: 'center'
                            });
                            this.cols[1].splice(0, 0, {
                                    title: 'Somatic',
                                    field: 'samples',
                                    rowspan: 1,
                                    colspan: 1,
                                    halign: 'center'
                                },
                                {
                                    title: 'Germline',
                                    field: 'samples',
                                    rowspan: 1,
                                    colspan: 1,
                                    halign: 'center'
                                }
                            );
                            break;
                        case "caseControl":
                            this.cols[0].splice(5, 0, {
                                title: 'Samples',
                                field: 'samples',
                                rowspan: 1,
                                colspan: 2,
                                halign: 'center'
                            });
                            this.cols[1].splice(0, 0, {
                                    title: 'Control',
                                    field: 'samples',
                                    rowspan: 1,
                                    colspan: 1,
                                    halign: 'center'
                                },
                                {
                                    title: 'Case',
                                    field: 'samples',
                                    rowspan: 1,
                                    colspan: 1,
                                    halign: 'center'
                                }
                            );
                            break;
                        default:
                            break;
                    }
                }


                this.renderFromServer();
            }
            _createDefaultColumns() {
                var initCols = [
                    [
                        {
//                            title: 'Select',
//                            field: {source: 'state', context: this},
                            field: "stateCheckBox",
                            checkbox: true,
                            colspan: 1,
                            rowspan: 2,
                            formatter: this.stateFormatter
                        },
                        {
                            title: 'Variant',
                            field: 'variant',
//                            sortable: true,
                            colspan: 1,
                            rowspan: 2,
                            formatter: this.variantFormatter,
                            halign: 'center'
                        },
                        {
                            title: 'SNP Id',
                            field: 'id',
                            colspan: 1,
                            rowspan: 2,
                            formatter: this.snpFormatter,
                            halign: 'center'
                        },
                        {
                            title: 'Genes',
                            field: {name: "genes", context: this},
                            colspan: 1,
                            rowspan: 2,
                            formatter: this.geneFormatter,
                            halign: 'center'
                        },
                        {
                            title: 'Type',
                            field: 'type',
                            colspan: 1,
                            rowspan: 2,
                            halign: 'center'
                        },
                        {
                            title: 'Consequence Type',
                            field: {context: this},
//                            sortable: true,
                            colspan: 1,
                            rowspan: 2,
                            formatter: this.consequenceTypeFormatter,
                            halign: 'center'
                        },
                        {
                            title: 'Deleteriousness <a data-toggle="tooltip" title="SIFT scores are classified into tolerated and deleterious. ' +
                            'Polyphen scores are classified into benign, possibly damaging, probably damaging and possibly & probably damaging. ' +
                            'Please, leave the cursor over each tag to visualize the actual score value. ' +
                            'SIFT score takes values in the range [0, infinite[, the lower the values, the more damaging the prediction. ' +
                            'Polyphen score takes values in the range [0, 1[, the closer to 2, the more damaging the prediction.">' +
                            '<i class="fa fa-info-circle" aria-hidden="true"></i></a>',
//                            field: 'Protein Substitution',
                            colspan: 3,
                            rowspan: 1,
                            halign: 'center'
                        },
                        {
                            title: 'Conservation  <a data-toggle="tooltip" title="Positive PhyloP scores measure conservation which is slower evolution than expected, at sites that are predicted to be conserved. Negative PhyloP scores measure acceleration, which is faster evolution than expected, at sites that are predicted to be fast-evolving. Absolute values of phyloP scores represent -log p-values under a null hypothesis of neutral evolution. The phastCons scores represent probabilities of negative selection and range between 0 and 1. Positive GERP scores represent a substitution deficit and thus indicate that a site may be under evolutionary constraint. Negative scores indicate that a site is probably evolving neutrally. Some authors suggest that a score threshold of 2 provides high sensitivity while still strongly enriching for truly constrained sites"><i class="fa fa-info-circle" aria-hidden="true"></i></a>',
                            field: 'Conservation',
                            colspan: 3,
                            rowspan: 1,
                            halign: 'center'
                        },
                        {
                            title: 'Phenotype',
                            field: 'Phenotype',
                            colspan: 3,
                            rowspan: 1,
                            halign: 'center'
                        }
                    ],
                    [
                        {
                            title: 'SIFT',
                            field: {source: 'sift', context: this},
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.proteinScoreFormatter,
                            halign: 'center'
                        },
                        {
                            title: 'Polyphen',
                            field: {source: 'polyphen', context: this},
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.proteinScoreFormatter,
                            halign: 'center'
                        },
                        {
                            title: 'CADD',
//                            field: {source: 'caddScaled', context: this},
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.caddScaledFormatter,
                            align: 'right',
                            halign: 'center'
                        },
                        {
                            title: 'PhyloP',
                            field: 'phylop',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.conservationFormatter,
                            align: 'right',
                            halign: 'center'
                        },
                        {
                            title: 'PhastCons',
                            field: 'phastCons',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.conservationFormatter,
                            align: 'right',
                            halign: 'center'
                        },
                        {
                            title: 'GERP',
                            field: 'gerp',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.conservationFormatter,
                            align: 'right',
                            halign: 'center'
                        },
                        {
                            title: 'Clinvar',
                            field: 'clinvar',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.clinvarFormatter,
                            halign: 'center'
                        },
                        {
                            title: 'Cosmic',
                            field: 'cosmic',
                            colspan: 1,
                            rowspan: 1,
                            formatter: this.clinvarFormatter,
                            halign: 'center'
                        }
//                        {
//                            title: 'GWAS',
//                            field: 'gwas',
//                            colspan: 1,
//                            rowspan: 1,
//                            halign: 'center'
//                        }
                    ]
                ];
                return initCols;
            }
            _downloadTabFile() {
                let urlQueryParams = this._getUrlQueryParams();
                let params = urlQueryParams.queryParams;
                params.limit = 1000; // Default limit is 1000 for now
                let _this = this;

                this.downloadRefreshIcon.css('display', 'inline-block');
                this.downloadIcon.css('display', 'none');
                this.opencgaClient.variants().query(params)
                    .then(function (response) {
                        let json = response.response[0].result;
                        let dataString = VariantUtils.jsonToTabConvert(json);
                        let data = new Blob([dataString.join('\n')], {type: 'text/plain'});
                        let file = window.URL.createObjectURL(data);
                        let a = document.createElement("a");
                        a.href = file;
                        a.download = _this.study.alias + ".txt";
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(function() {
                            document.body.removeChild(a);
                        }, 0);
                    })
                    .then(function() {
                        _this.downloadRefreshIcon.css('display', 'none');
                        _this.downloadIcon.css('display', 'inline-block');
                    });
            }
            _downloadJsonFile() {
                let urlQueryParams = this._getUrlQueryParams();
                let params = urlQueryParams.queryParams;
                params.limit = 1000; // Default limit is 1000 for now
                let _this = this;

                this.downloadRefreshIcon.css('display', 'inline-block');
                this.downloadIcon.css('display', 'none');
                this.opencgaClient.variants().query(params)
                    .then(function (response) {
//                        let json = response.response[0].result;
//                        let dataString = [];
//                        for (let i = 0; i < json.length; i++) {
//                            dataString.push(JSON.stringify(json[i]));
//                        }
//
//                        let data = new Blob([dataString.join('\n')], {type: 'application/json'});
//                        let file = window.URL.createObjectURL(data);
//                        let a = document.createElement("a");
//                        a.href = file;
//                        a.download = _this.study.alias + ".json";
//                        document.body.appendChild(a);
//                        a.click();
//                        setTimeout(function() {
//                            document.body.removeChild(a);
//                        }, 0);
                    })
                    .then(function () {
                        _this.downloadRefreshIcon.css('display', 'none');
                        _this.downloadIcon.css('display', 'inline-block');
                    });
            }
            _shareLink() {
                let _this = this;
                $("[data-toggle=popover]").popover({
                    content: function() {
                        let getUrlQueryParams = _this._getUrlQueryParams();
                        return getUrlQueryParams.url;
                    }
                }).on("show.bs.popover", function () {
                    $(this).data("bs.popover").tip().css("max-width", "none");
                });
            }
            _saveLink() {
                let saveObject = {query: this.search, variants: $('#' + this.prefix + 'VariantBrowserGrid').bootstrapTable('getAllSelections')};
//                this.fire("save", saveObject);
                this.dispatchEvent(new CustomEvent("save", {detail: saveObject, bubbles: true, composed: true}));
            }
        }

        customElements.define(VariantBrowserGrid.is, VariantBrowserGrid);
    </script>
</dom-module>
