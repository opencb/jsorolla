<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../opencga-active-filters.html">

<dom-module id="variant-facet-view">
    <template>
        <style include="jso-styles"></style>

        <div>
            <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}" alias="{{activeFilterAlias}}"
                                    fixed-filters="{{fixedFilters}}" refresh="{{search}}">
            </opencga-active-filters>

            <div class="panel panel-default col-sm-12">
                <!-- Facet Fields -->
                <div class="col-sm-10">
                    <h3>Fields</h3>
                    <div class="form-group row">
                        <div class="col-sm-2">
                            <select id="{{prefix}}FacetField" class$="form-control {{prefix}}FilterSelect">
                                <option value="none" selected>Select a field...</option>
                                <template is="dom-repeat" items="{{config.fields}}">
                                    <option value="{{item.value}}">{{item.name}}</option>
                                </template>
                                <template is="dom-repeat" items="{{facetFieldsName}}" filter="_isValidField">
                                    <option value="{{item.value}}">{{item.name}}</option>
                                </template>
                            </select>
                        </div>
                        <div class="col-sm-2">
                            <textarea class="form-control" rows="1" id="{{prefix}}FieldIncludes"
                                      placeholder="Include values"></textarea>
                        </div>
                        <div class="col-sm-2">
                            <select id="{{prefix}}FacetFieldNested" class$="form-control {{prefix}}FilterSelect">
                                <option value="none" selected>Nested field...</option>
                                <template is="dom-repeat" items="{{config.fields}}">
                                    <option value="{{item.value}}">{{item.name}}</option>
                                </template>
                            </select>
                        </div>
                        <div class="col-sm-2">
                            <textarea class="form-control" rows="1" id="{{prefix}}NestedFieldIncludes"
                                      placeholder="Include values"></textarea>
                        </div>
                        <button type="button" class="btn btn-primary" on-click="addFacets" style="cursor: pointer">Add
                        </button>
                    </div>

                    <template is="dom-repeat" items="{{facetFieldsName}}">
                        <span style="font-size: 14px">
                            <span title="Remove field" style="padding: 0px 0px 20px 20px">
                                <i class="fa fa-times fa-lg" aria-hidden="true" on-click="removeFacetField"
                                   data-id="{{item.value}}" data-field="field"
                                   style="color: darkred;cursor: pointer"></i>
                            </span>&nbsp;{{item.name}}
                        </span>
                    </template>
                </div>

                <!-- Facet Range -->
                <div class="col-sm-10">
                    <h3>Ranges</h3>

                    <!-- Chromosomes -->
                    <label>Chromosome</label>
                    <div class="form-group row">
                        <div class="col-sm-2">
                            <input type="text" class="form-control" id="{{prefix}}ChromosomeInput" placeholder="1">
                        </div>

                        <div class="col-sm-2">
                            <div class="input-group">
                                <span class="input-group-addon">Chunk</span>
                                <select id="{{prefix}}ChromosomeRangeGap" class$="form-control {{prefix}}FilterSelect">
                                    <option value="1000000" selected>1 Mb</option>
                                    <option value="2000000">2 Mb</option>
                                    <option value="5000000">5 Mb</option>
                                    <option value="10000000">10 Mb</option>
                                </select>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" id="{{prefix}}ChromosomeAdd" on-click="addFacets"
                                style="cursor: pointer">Add
                        </button>
                    </div>

                    <!-- Conservation & Deleteriousness -->
                    <label>Conservation & Deleteriousness</label>
                    <div class="form-group row">
                        <div class="col-sm-2">
                            <select id="{{prefix}}FacetRangeField" class$="form-control {{prefix}}FilterSelect">
                                <option value="none" selected>Select a field...</option>
                                <template is="dom-repeat" items="{{config.ranges}}">
                                    <option value="{{item.value}}">{{item.name}}</option>
                                </template>
                            </select>
                        </div>

                        <div class="col-sm-2">
                            <div class="input-group">
                                <span class="input-group-addon">Start</span>
                                <input type="text" class="form-control" id="{{prefix}}FacetRangeStart" value="0">
                            </div>
                        </div>

                        <div class="col-sm-2">
                            <div class="input-group">
                                <span class="input-group-addon">End</span>
                                <input type="text" class="form-control" id="{{prefix}}FacetRangeEnd" value="1">
                            </div>
                        </div>

                        <div class="col-sm-2">
                            <div class="input-group">
                                <span class="input-group-addon">Interval</span>
                                <input type="text" class="form-control" id="{{prefix}}FacetRangeGap" value="0.1">
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" on-click="addFacets" style="cursor: pointer">Add
                        </button>
                    </div>

                    <!-- Population frequency -->
                    <label>Population frequency</label>
                    <div class="form-group row">
                        <div class="col-sm-2">
                            <select id="{{prefix}}PopFreqRangeField" class$="form-control {{prefix}}FilterSelect">
                                <option value="none" selected>Select a population...</option>
                                <template is="dom-repeat" items="{{populationFrequencies.studies}}" as="study">
                                    <template is="dom-repeat" items="{{study.populations}}" as="population">
                                        <option value="{{study.id}}_{{population.id}}">{{study.id}}_{{population.id}}
                                        </option>
                                    </template>
                                </template>
                            </select>
                        </div>

                        <div class="col-sm-2">
                            <div class="input-group">
                                <span class="input-group-addon">Start</span>
                                <input type="text" class="form-control" id="{{prefix}}PopFreqRangeStart" value="0">
                            </div>
                        </div>

                        <div class="col-sm-2">
                            <div class="input-group">
                                <span class="input-group-addon">End</span>
                                <input type="text" class="form-control" id="{{prefix}}PopFreqRangeEnd" value="1">
                            </div>
                        </div>

                        <div class="col-sm-2">
                            <div class="input-group">
                                <span class="input-group-addon">Interval</span>
                                <input type="text" class="form-control" id="{{prefix}}PopFreqRangeGap" value="0.1">
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" on-click="addFacets" style="cursor: pointer">Add
                        </button>
                    </div>

                    <template is="dom-repeat" items="{{facetRangeFields}}">
                        <span style="font-size: 14px">
                            <span title="Remove field" style="padding: 0px 0px 20px 20px">
                                <i class="fa fa-times fa-lg" aria-hidden="true" on-click="removeFacetField"
                                   data-id="{{item}}" data-field="range" style="color: darkred;cursor: pointer"></i>
                            </span>&nbsp;{{item}}
                        </span>
                    </template>
                </div>

                <div class="col-sm-12">
                    <div style="float: right; padding: 0px 0px 10px 5px">
                        <button type="button" class="btn btn-primary btn-lg" on-click="render">Refresh</button>
                    </div>

                    <div style="float: right; padding: 0px 0px 10px 0px">
                        <button type="button" class="btn btn-primary btn-lg" on-click="clearAll">Clear</button>
                    </div>
                </div>
            </div>


            <!-- RESULTS - Facet Plots -->
            <h2>Results</h2>

            <template is="dom-if" if="{{_showInitMessage}}">
                <h3>No facet filters selected</h3>
            </template>

            <!--<h4>Total Number of Variants : {{totalVariants}}</h4>-->
            <template is="dom-repeat" items="{{results}}" id="resultsDiv">
                <h3>{{item.title}}</h3>
                <div class="btn-group" style="float: right">
                    <span class="btn btn-primary plots active" on-click="onHistogramChart">
                        <i class="fa fa-bar-chart" style="padding-right: 5px" title="Bar Chart"
                           data-id="{{item.name}}"></i>
                    </span>
                    <template is="dom-if" if="{{item.renderPieChart}}">
                        <span class="btn btn-primary plots" on-click="onPieChart">
                            <i class="fa fa-pie-chart" style="padding-right: 5px" title="Pie Chart"
                               data-id="{{item.name}}"></i>
                        </span>
                    </template>
                    <span class="btn btn-primary plots" on-click="onTabularView">
                        <i class="fa fa-table" style="padding-right: 5px" title="Tabular View"
                           data-id="{{item.name}}"></i>
                    </span>
                </div>
                <div id="{{prefix}}{{item.name}}Plot"></div>

                <!--Table-->
                <br>
                <table class="table table-bordered" id="{{prefix}}{{item.name}}Table" style="display: none;">

                    <!-- Facet Field Table -->
                    <template is="dom-if" if="{{checkField(item.category)}}">
                        <thead class="table-header bg-primary">
                        <tr>
                            <th>{{item.title}}</th>
                            <template is="dom-if" if="{{subFieldExists(item.subField)}}">
                                <th>{{item.subField}}</th>
                            </template>
                            <th>Number of Variants</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{item.counts}}" as="count">
                            <template is="dom-if" if="{{fieldExists(count)}}">
                                <tr>
                                    <td rowspan$="{{countSubFields(count)}}">{{count.value}}</td>
                                </tr>

                                <template is="dom-repeat" items="{{count.field.counts}}" as="subFieldCount">
                                    <tr>
                                        <td>{{subFieldCount.value}}</td>
                                        <td>{{subFieldCount.count}}</td>
                                    </tr>
                                </template>
                            </template>

                            <template is="dom-if" if="{{!fieldExists(count)}}">
                                <tr>
                                    <td>{{count.value}}</td>
                                    <td>{{count.count}}</td>
                                </tr>
                            </template>
                        </template>
                        </tbody>
                    </template>

                    <!-- Facet Range Table -->
                    <template is="dom-if" if="{{!checkField(item.category)}}">
                        <thead class="table-header bg-primary">
                        <tr>
                            <th>Range</th>
                            <th>Number of Variants</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{item.data}}" as="data">
                            <tr>
                                <td>{{data.range}}</td>
                                <td>{{data.count}}</td>
                            </tr>
                        </template>
                        </tbody>
                    </template>
                </table>
                <br>
            </template>
        </div>

        <div class="modal fade" id="{{prefix}}LoadingModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
             role="dialog"
             aria-hidden="true" style="padding-top:15%; overflow-y:visible;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Loading...</h3>
                    </div>
                    <div class="modal-body">
                        <div class="progress progress-striped active">
                            <div class="progress-bar progress-bar-success" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </template>
    <script>

        class VariantFacetView extends Polymer.Element {

            static get is() {
                return 'variant-facet-view';
            }

            static get properties() {
                return {
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object
                    },
                    config: {
                        type: Object
                    },
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    query: {
                        type: Object
                    },
                    search: {
                        type: Object,
                        observer: 'fetchVariants'
                    }
                }
            }

            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
                if (UtilsNew.isEmpty(this.prefix)) {
                    this.prefix = "facet" + Utils.randomString(6);
                }

                this.activeFilterAlias = {
                    "annot-xref": "XRef",
                    "annot-biotype": "Biotype",
                    "annot-ct": "Consequence Types",
                    "annot-population-maf": "Population Frequency",
                    "annot-functional-score": "CADD",
                    "protein_substitution": "Protein Substitution",
                    "annot-go": "GO",
                    "annot-hpo": "HPO"
                };

                this.fixedFilters = ["studies"];

                // These are for making the queries to server
                this.facetFields = [];
                this.facetRanges = [];

                this.facetFieldsName = [];
                this.facetRangeFields = [];

                this.results = [];
                this._showInitMessage = true;
            }

            addFacets() {
                // Facets
                if (PolymerUtils.getValue(this.prefix + "FacetField") != "none") {
                    let field = {
                        name: PolymerUtils.getTextOptionSelected(this.prefix + "FacetField"),
                        value: PolymerUtils.getValue(this.prefix + "FacetField")
                    };
                    // Includes for facet field
                    if (PolymerUtils.isNotEmptyValueById(this.prefix + "FieldIncludes")) {
                        field.name += "[" + PolymerUtils.getValue(this.prefix + "FieldIncludes") + "]";
                        field.value += "[" + PolymerUtils.getValue(this.prefix + "FieldIncludes") + "]";
                    }

                    // Check if the nested field is a valid value
                    if (PolymerUtils.getValue(this.prefix + "FacetFieldNested") != "none"
                        && PolymerUtils.getValue(this.prefix + "FacetFieldNested") != PolymerUtils.getValue(this.prefix + "FacetField")) {
                        // Take it into account only if it is not present already in the selected values

                        if (this.facetFields.indexOf(PolymerUtils.getValue(this.prefix + "FacetField") + ">>" + PolymerUtils.getValue(this.prefix + "FacetFieldNested")) == -1) {
                            let nestedField = {
                                name: PolymerUtils.getTextOptionSelected(this.prefix + "FacetFieldNested"),
                                value: PolymerUtils.getValue(this.prefix + "FacetFieldNested")
                            };
                            // Includes for nested facet field
                            if (PolymerUtils.isNotEmptyValueById(this.prefix + "NestedFieldIncludes")) {
                                nestedField.name += "[" + PolymerUtils.getValue(this.prefix + "NestedFieldIncludes") + "]";
                                nestedField.value += "[" + PolymerUtils.getValue(this.prefix + "NestedFieldIncludes") + "]";
                            }

                            this.push('facetFieldsName', {
                                name: field.name + " >> " + nestedField.name,
                                value: field.value + ">>" + nestedField.value
                            });
                            this.push('facetFields', field.value + ">>" + nestedField.value);
                        }
                    } else {
                        this.push('facetFieldsName', {
                            name: field.name,
                            value: field.value
                        });
                        this.push('facetFields', field.value);
                    }
                    PolymerUtils.setValue(this.prefix + "FacetField", "none");
                    PolymerUtils.setValue(this.prefix + "FacetFieldNested", "none");
                    PolymerUtils.setValue(this.prefix + "FieldIncludes", "");
                    PolymerUtils.setValue(this.prefix + "NestedFieldIncludes", "");
                }

                // Facets Range
                if (PolymerUtils.getValue(this.prefix + "FacetRangeField") !== "none" && PolymerUtils.isNotEmptyValueById(this.prefix + "FacetRangeStart")
                    && PolymerUtils.isNotEmptyValueById(this.prefix + "FacetRangeEnd") && PolymerUtils.isNotEmptyValueById(this.prefix + "FacetRangeGap")
                    && !isNaN(PolymerUtils.getValue(this.prefix + "FacetRangeStart")) && !isNaN(PolymerUtils.getValue(this.prefix + "FacetRangeEnd"))
                    && !isNaN(PolymerUtils.getValue(this.prefix + "FacetRangeGap"))) {
                    // if any of the field is already selected, remove the old value before pushing
                    for (let i = 0; i < this.facetRanges.length; i++) {
                        if (this.facetRanges[i].startsWith(PolymerUtils.getValue(this.prefix + "FacetRangeField"))) {
                            this.splice('facetRanges', i, 1);
                            this.splice('facetRangeFields', i, 1);
                            break;
                        }
                    }
                    this.push('facetRangeFields', PolymerUtils.getTextOptionSelected(this.prefix + "FacetRangeField")
                        + "[" + PolymerUtils.getValue(this.prefix + "FacetRangeStart")
                        + "," + PolymerUtils.getValue(this.prefix + "FacetRangeEnd") + "], Interval :" + PolymerUtils.getValue(this.prefix + "FacetRangeGap"));
                    this.push('facetRanges', PolymerUtils.getValue(this.prefix + "FacetRangeField") + ":" + PolymerUtils.getValue(this.prefix + "FacetRangeStart")
                        + ":" + PolymerUtils.getValue(this.prefix + "FacetRangeEnd") + ":" + PolymerUtils.getValue(this.prefix + "FacetRangeGap"));

                    PolymerUtils.setValue(this.prefix + "FacetRangeField", "none");
                    PolymerUtils.setValue(this.prefix + "FacetRangeStart", "0");
                    PolymerUtils.setValue(this.prefix + "FacetRangeEnd", "1");
                    PolymerUtils.setValue(this.prefix + "FacetRangeGap", "0.1");
                }

                // Population Frequency Range
                if (PolymerUtils.getValue(this.prefix + "PopFreqRangeField") !== "none" && PolymerUtils.isNotEmptyValueById(this.prefix + "PopFreqRangeStart")
                    && PolymerUtils.isNotEmptyValueById(this.prefix + "PopFreqRangeEnd") && PolymerUtils.isNotEmptyValueById(this.prefix + "PopFreqRangeGap")
                    && !isNaN(PolymerUtils.getValue(this.prefix + "PopFreqRangeStart")) && !isNaN(PolymerUtils.getValue(this.prefix + "PopFreqRangeEnd"))
                    && !isNaN(PolymerUtils.getValue(this.prefix + "PopFreqRangeGap"))) {
                    // if any of the field is already selected, remove the old value before pushing
                    this.facetRanges.forEach(function (element, index) {
                        if (element.startsWith(PolymerUtils.getValue(this.prefix + "PopFreqRangeField"))) {
                            facetRanges.splice(index, 1);
                            facetRangeFields.splice(index, 1);
                        }
                    });


                    this.push('facetRangeFields', PolymerUtils.getValue(this.prefix + "PopFreqRangeField") + "[" + PolymerUtils.getValue(this.prefix + "PopFreqRangeStart")
                        + "," + PolymerUtils.getValue(this.prefix + "PopFreqRangeEnd") + "], Interval: " + PolymerUtils.getValue(this.prefix + "PopFreqRangeGap"));
                    this.push('facetRanges', "popFreq_" + PolymerUtils.getValue(this.prefix + "PopFreqRangeField") + ":" + PolymerUtils.getValue(this.prefix + "PopFreqRangeStart")
                        + ":" + PolymerUtils.getValue(this.prefix + "PopFreqRangeEnd") + ":" + PolymerUtils.getValue(this.prefix + "PopFreqRangeGap"));

                    PolymerUtils.setValue(this.prefix + "PopFreqRangeField", "none");
                    PolymerUtils.setValue(this.prefix + "PopFreqRangeStart", "0");
                    PolymerUtils.setValue(this.prefix + "PopFreqRangeEnd", "1");
                    PolymerUtils.setValue(this.prefix + "PopFreqRangeGap", "0.1");
                }

                // Chromosome
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "ChromosomeInput")) {
                    this.chromosome = PolymerUtils.getValue(this.prefix + "ChromosomeInput");
                    let _this = this;
                    if (UtilsNew.isNotUndefined(this.cellbaseClient) && this.cellbaseClient instanceof CellBaseClient) {
                        this.cellbaseClient.get("genomic", "chromosome", this.chromosome, "info", {})
                            .then(function (response) {
                                let chromosome = response.response[0].result[0].chromosomes[0];
                                _this.push("facetRanges", "start:" + chromosome.start + ":" + chromosome.size + ":"
                                    + PolymerUtils.getValue(_this.prefix + "ChromosomeRangeGap"));
                                _this.push("facetRangeFields", chromosome.name + "[" + chromosome.start + "," + chromosome.size + "], Interval: "
                                    + PolymerUtils.getValue(_this.prefix + "ChromosomeRangeGap"));

                                PolymerUtils.setValue(_this.prefix + "ChromosomeInput", "");
                                PolymerUtils.setValue(_this.prefix + "ChromosomeRangeGap", "1000000");
                                PolymerUtils.setAttribute(_this.prefix + "ChromosomeAdd", "disabled", true);
                            });
                    }
                }

            }

            removeFacetField(e) {
                if (e.target.dataset.field === "field") {
                    let index = this.facetFields.indexOf(e.target.dataId);
                    facetFields.splice(index, 1);

                    this.facetFieldsName.forEach(function (element, index) {
                        if (element.value === e.target.dataId) {
                            facetFieldsName.splice(index, 1);
                        }
                    });


                } else if (e.target.dataset.field === "range") {
                    let index = this.facetRangeFields.indexOf(e.target.dataId);
                    if (this.facetRanges[index].startsWith("start")) {
                        PolymerUtils.removeAttribute(this.prefix + "ChromosomeAdd", "disabled");
                    }
                    this.splice('facetRangeFields', index, 1);
                    this.splice('facetRanges', index, 1);
                }
            }

            render() {
                if (UtilsNew.isUndefined(this.opencgaClient)) {
                    return;
                }

                if (this.facetFields.length === 0 && this.facetRangeFields.length === 0) {
                    alert("Add some facet fields.");
                    return;
                }

                this.clearPlots();

                // Shows loading modal
                $(PolymerUtils.getElementById(this.prefix + "LoadingModal")).modal("show");

                let _fieldNamesMap = {};
                for (let f of this.config.fields) {
                    _fieldNamesMap[f.value] = f.name;
                }
                for (let f of this.config.ranges) {
                    _fieldNamesMap[f.value] = f.name;
                }
                // Add chromosome to _fieldNamesMap
                _fieldNamesMap["start"] = "Chromosome";

                this.fieldNamesMap = _fieldNamesMap;

                let queryParams = {
//                    sid: this.opencgaClient._config.sessionId,
                    timeout: 60000
                };
                if (UtilsNew.isNotUndefinedOrNull(this.opencgaClient._config.sessionId)) {
                    queryParams.sid = this.opencgaClient._config.sessionId;
                }
                Object.assign(queryParams, this.query);

//                if (UtilsNew.isNotEmpty(queryParams.sid)) {
//                    delete queryParams["sid"];
//                }

                if (UtilsNew.isEmpty(queryParams.studies) || queryParams.studies.split(new RegExp("[,;]")).length === 1) {
                    queryParams.studies = this.project.alias + ":" + this.study.alias;
                }

                if (UtilsNew.isNotEmpty(this.chromosome)) {
                    queryParams.region = this.chromosome;
                }
                if (this.facetFields.length > 0) {
                    queryParams.facet = this.facetFields.join(";");
                }
                if (this.facetRanges.length > 0) {
                    queryParams.facetRange = this.facetRanges.join(";");
                }

                let _this = this;
                // Promise needs to be executed in a setTimeout to give time the browser to update the DOM and show the loading modal
                setTimeout(() => {
                    this.opencgaClient.variants().facet(queryParams, {})
                    .then(function (queryResponse) {
                        let response = queryResponse.response[0].result[0].result;

                        let _facetResults = {};
                        let _results = [];

                        // Facet fields
                        for (let field of response.fields) {
                            let _name;
                            let _subField = "";
                            if (UtilsNew.isUndefined(field.counts[0].field)) {
                                _name = field.name;
                            } else {
                                _name = field.name + "-" + field.counts[0].field.name;
                                _subField = field.counts[0].field.name;
                            }
                            _facetResults[_name] = field;
                            _facetResults[_name].title = _this.fieldNamesMap[field.name]; // Setting title before we modify name property
                            _facetResults[_name].name = _name;
                            _facetResults[_name].subField = _this.fieldNamesMap[_subField];
                            _facetResults[_name].renderHistogramChart = true;
                            _facetResults[_name].renderPieChart = true;
                            _facetResults[_name].category = "field";
                            _results.push(_facetResults[field.name]);
                        }

                        // Facet Ranges
                        for (let range of response.ranges) {
                            _facetResults[range.name] = range;
                            _facetResults[range.name].title = _this.fieldNamesMap[range.name];
                            _facetResults[range.name].renderHistogramChart = true;
                            _facetResults[range.name].renderPieChart = false;
                            _facetResults[range.name].category = "range";

                            // Preparing data for table
                            let data = [];
                            let start = Number(range.start);
                            for (let rangeCount of range.counts) {
                                if (Math.round(start) !== start) {
                                    start = Number(start.toFixed(1));
                                }
                                let end = Number(start + range.gap);
                                if (Math.round(end) !== end) {
                                    end = Number(end.toFixed(1));
                                }
                                data.push({
                                    range: start + "-" + end,
                                    count: rangeCount
                                });
                                start = end;
                            }
                            _facetResults[range.name].data = data;

                            _results.push(_facetResults[range.name]);
                        }

                        _this.facetResults = Object.assign({}, _facetResults);
                        _this.results = _results;

                        _this.$.resultsDiv.render();
                        for (let result of _this.results) {
                            _this.renderHistogramChart("#" + _this.prefix + result.name + "Plot", result.name);
                        }

                        // Remove loading modal
                        $(PolymerUtils.getElementById(_this.prefix + "LoadingModal")).modal("hide");
                        _this._showInitMessage = false;
                    })
                    .catch(function (e) {
                        console.log(e);
                        // Remove loading modal
                        $(PolymerUtils.getElementById(_this.prefix + "LoadingModal")).modal("hide");
                        _this._showInitMessage = false;
                    });}
                    ,250);

            }

            clearPlots() {
                if (UtilsNew.isNotUndefined(this.results) && this.results.length > 0) {
                    for (let result of this.results) {
                        PolymerUtils.removeElement(this.prefix + result.name + "Plot");
                    }
                }
                this.results = [];
            }

            clearAll() {
                this.clearPlots();
                this.chromosome = "";
                this.facetFields = [];
                this.facetRanges = [];
                this.facetFieldsName = [];
                this.facetRangeFields = [];
                this._showInitMessage = true;

                PolymerUtils.setAttributeByClassName(this.prefix + 'FilterSelect', 'selectedIndex', 0);

                PolymerUtils.setValue(this.prefix + "FieldIncludes", "");
                PolymerUtils.setValue(this.prefix + "NestedFieldIncludes", "");
                PolymerUtils.setValue(this.prefix + "ChromosomeInput", "");
                PolymerUtils.removeAttribute(this.prefix + "ChromosomeAdd", "disabled");
            }

            onHistogramChart(e) {
                this.highlightActivePlot(e.target.parentElement);
                let id = e.target.dataId;
                //TODO Refactor
                this.renderHistogramChart("#" + this.prefix + id + "Plot", id);

                PolymerUtils.hide(this.prefix + id + "Table");
            }

            onPieChart(e) {
                this.highlightActivePlot(e.target.parentElement);
                let id = e.target.dataId;
                this.renderPieChart("#" + this.prefix + id + "Plot", id);
                PolymerUtils.hide(this.prefix + id + "Table");
            }

            onTabularView(e) {
                this.highlightActivePlot(e.target.parentElement);
                let id = e.target.dataId;
                PolymerUtils.innerHTML(this.prefix + id + "Plot", "");
                PolymerUtils.show(this.prefix + id + "Table", "table");
            }

            highlightActivePlot(button) {
                PolymerUtils.removeClass(".plots", "active");
                PolymerUtils.addClass(button, "active");
            }

            renderHistogramChart(div, id) {
                let params = this._getHistogramData(id);

                $(div).highcharts({
                    credits: {enabled: false},
                    chart: {
                        type: "column"
                    },
                    title: {
                        text: params.title || params.name
                    },
                    xAxis: {
                        categories: params.categories
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Total number of Variants'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y:.1f} </b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: params.series
                });
            }

            renderPieChart(div, id) {
                let params;
                let renderDonut = false;
                if (UtilsNew.isNotUndefined(this.facetResults[id]) && UtilsNew.isNotUndefined(this.facetResults[id].counts[0].field)) {
                    params = this._getDonutData(id);
                    renderDonut = true;
                } else {
                    params = this._getPieData(id);
                }

                if (renderDonut) {
                    $(div).highcharts({
                        credits: {enabled: false},
                        chart: {
                            type: 'pie'
                        },
                        title: {
                            text: params.title || params.name
                        },
                        plotOptions: {
                            pie: {
                                shadow: false,
                                center: ['50%', '50%']
                            }
                        },
                        series: params.series
                    });
                } else {
                    $(div).highcharts({
                        credits: {enabled: false},
                        chart: {
                            plotBackgroundColor: null,
                            plotBorderWidth: null,
                            plotShadow: false,
                            type: 'pie'
                        },
                        title: {
                            text: params.title
                        },
                        tooltip: {
                            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                        },
                        plotOptions: {
                            pie: {
                                allowPointSelect: true,
                                cursor: 'pointer',
                                dataLabels: {
                                    enabled: false
                                },
                                showInLegend: true
                            }
                        },
                        series: params.series
                    });
                }
            }

            _getHistogramData(id) {
                let params;
                if (this.facetResults[id].category === "field") {
                    let field = this.facetResults[id];
                    let fields = field.name.split("-");
                    let title = [];
                    if (fields.length > 1) {
                        for (let name of fields) {
                            title.push(this.fieldNamesMap[name]);
                        }
                    } else {
                        title.push(this.fieldNamesMap[field.name]);
                    }
                    let obj = {
                        name: field.name,
                        title: title.join(" - "),
                        categories: [],
                        series: []
                    };
                    let series = {};
                    let data = [];
                    for (let i = 0; i < field.counts.length; i++) {
                        let countObj = field.counts[i];
                        obj.categories.push(countObj.value);
                        if (UtilsNew.isNotUndefined(countObj.field)) {
                            obj.nestedField = countObj.field.name;
                            for (let nestedCountObj of countObj.field.counts) {
                                if (UtilsNew.isUndefined(series[nestedCountObj.value])) {
                                    series[nestedCountObj.value] = [];
                                }
                                // It is important to push 'index' as we need to take care of the missing values
                                series[nestedCountObj.value].push({index: i, count: nestedCountObj.count});
                            }
                        } else {
                            data.push(countObj.count);
                        }
                    }

                    if (Object.keys(series).length > 0) {
                        for (let key in series) {
                            let data = [];
                            for (let countIndex of series[key]) {
                                data[countIndex.index] = countIndex.count;
                            }
                            for (let i = 0; i < data.length; i++) {
                                if (UtilsNew.isUndefined(data[i])) {
                                    data[i] = 0; // Setting '0' for missing fields
                                }
                            }
                            obj.series.push({name: key, data: data});
                        }
                    } else {
                        obj.series.push({name: field.name, data: data});
                    }
                    params = obj;
                } else if (this.facetResults[id].category === "range") {
                    let range = this.facetResults[id];
                    let obj = {
                        name: range.name,
                        title: this.fieldNamesMap[range.name] || range.name,
                        categories: [],
                        series: [],
                    };
                    let data = [];
                    let start = Number(range.start);
                    for (let rangeCount of range.counts) {
                        if (Math.round(start) !== start) {
                            start = Number(start.toFixed(1));
                        }
                        let end = Number(start + range.gap);
                        if (Math.round(end) !== end) {
                            end = Number(end.toFixed(1));
                        }
                        obj.categories.push(start + "-" + end);
                        data.push(rangeCount);
                        start = end;
                    }
                    obj.series.push({name: range.name, data: data});
                    params = obj;
                }
                return params;
            }

            _getPieData(id) {
                let field = this.facetResults[id];
                let pieData = {
                    name: field.name,
                    title: this.fieldNamesMap[field.name],
                    series: []
                };
                let data = [];
                for (let countObj of field.counts) {
                    data.push({name: countObj.value, y: countObj.count});
                }
                pieData.series.push({
                    name: field.name,
                    colorByPoint: true,
                    data: data
                });

                return pieData;
            }

            _getDonutData(id) {
                let field = this.facetResults[id];
                let fields = field.name.split("-");
                let title = [];
                if (fields.length > 1) {
                    for (let name of fields) {
                        title.push(this.fieldNamesMap[name]);
                    }
                } else {
                    title.push(this.fieldNamesMap[field.name]);
                }
                let donutData = {
                    name: field.name,
                    title: title.join(" - "),
                    series: []
                };

                let colors = Highcharts.getOptions().colors;
                let categories = [];
                let data = [];
                for (let i = 0; i < field.counts.length; i++) {
                    let fieldObj = field.counts[i];
                    categories.push(fieldObj.value);
                    let subField = fieldObj.field;
                    let subCategories = [];
                    let subData = [];
                    for (let countObj of subField.counts) {
                        subCategories.push(countObj.value);
                        subData.push(countObj.count);
                    }
                    data.push({
                        y: fieldObj.count,
                        color: colors[i],
                        drilldown: {
                            name: subField.name,
                            categories: subCategories,
                            data: subData,
                            color: colors[i]
                        }
                    });
                }
                let levelOneData = [];
                let levelTwoData = [];

                // Build the data arrays
                for (let i = 0; i < data.length; i++) {
                    // add level one data
                    levelOneData.push({
                        name: categories[i],
                        y: data[i].y,
                        color: data[i].color
                    });

                    // add level two data
                    let drillDataLen = data[i].drilldown.data.length;
                    for (let j = 0; j < drillDataLen; j++) {
                        let brightness = 0.2 - (j / drillDataLen) / 5;
                        levelTwoData.push({
                            name: data[i].drilldown.categories[j],
                            y: data[i].drilldown.data[j],
                            color: Highcharts.Color(data[i].color).brighten(brightness).get()
                        });
                    }
                }

                let [levelOneField, levelTwoField] = field.name.split("-");
                donutData.series.push({
                    name: levelOneField,
                    data: levelOneData,
                    size: '60%',
                    dataLabels: {
                        formatter: function () {
                            return this.y > 5 ? this.point.name : null;
                        },
                        color: '#ffffff',
                        distance: -30
                    }
                });
                donutData.series.push({
                    name: levelTwoField,
                    data: levelTwoData,
                    size: '80%',
                    innerSize: '60%',
                    dataLabels: {
                        formatter: function () {
                            // display only if larger than 1
                            return this.y > 1 ? '<b>' + this.point.name + ':</b> ' + this.y : null;
                        }
                    }
                });
                return donutData;
            }

            fetchVariants() {
                if (UtilsNew.isNotUndefined(this.opencgaClient)) {
                    let queryParams = {
                        sid: this.opencgaClient._config.sessionId,
                        timeout: 60000,
                        summary: true,
                        limit: 1
                    };
                    Object.assign(queryParams, this.query);

                    if (UtilsNew.isEmpty(queryParams.studies) || queryParams.studies.split(new RegExp("[,;]")).length == 1) {
                        queryParams.studies = this.project.alias + ":" + this.study.alias;
                    }

                    let _this = this;
                    this.opencgaClient.variants().query(queryParams, {})
                        .then(function (response) {
                            _this.totalVariants = response.response[0].numTotalResults;
                        });
                }
            }

            checkField(category) {
                return category === "field";
            }

            subFieldExists(field) {
                return UtilsNew.isNotEmpty(field);
            }

            fieldExists(countObj) {
                return UtilsNew.isNotUndefined(countObj.field);
            }

            countSubFields(countObj) {
                return countObj.field.counts.length + 1;
            }

            _isValidField(item) {
                for (let field of this.config.fields) {
                    if (field.value == item.value) {
                        return false;
                    }
                }
                return true;
            }
        }

        customElements.define(VariantFacetView.is, VariantFacetView);


    </script>
</dom-module>
